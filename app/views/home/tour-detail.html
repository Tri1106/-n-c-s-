<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi ti·∫øt Tour</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        color: #333;
      }

      .container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
      }

      .sidebar {
        width: 100px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .sidebar img {
        width: 100%;
        border-radius: 8px;
        object-fit: cover;
      }

      .main-image {
        flex: 1;
        min-width: 300px;
      }

      .main-image img {
        width: 100%;
        border-radius: 12px;
      }

      .info-box {
        width: 300px;
        border: 1px solid #eee;
        border-radius: 12px;
        padding: 20px;
        background-color: #f9f9f9;
      }

      .info-box h2 {
        color: #e53935;
        margin: 0;
      }

      .info-box .old-price {
        text-decoration: line-through;
        color: gray;
      }

      .info-box .new-price {
        font-size: 1.8rem;
        color: red;
        font-weight: bold;
      }

      .info-box .tagline {
        background-color: #ffe0e0;
        padding: 10px;
        margin: 10px 0;
        border-radius: 8px;
        font-weight: bold;
        color: #c62828;
      }

      .info-box ul {
        list-style: none;
        padding-left: 0;
      }

      .info-box ul li {
        margin: 5px 0;
      }

      .info-box button {
        background-color: red;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        width: 100%;
        font-weight: bold;
        margin-top: 15px;
      }

      .actions {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
      }

      .actions button {
        background: #1976d2;
        color: white;
        padding: 10px;
        border: none;
        border-radius: 8px;
        width: 48%;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1 id="tour-title">Loading...</h1>

    <div class="container">
      <!-- Sidebar image list -->
      <div class="sidebar" id="sidebar-images">
        <!-- Images will be inserted here -->
      </div>

      <!-- Main tour image -->
      <div class="main-image">
        <img id="main-image" src="" alt="·∫£nh tour ch√≠nh" />
      </div>

      <!-- Tour Info -->
      <div class="info-box">
        <h2 id="tour-price">Loading...</h2>
        <div class="old-price" id="old-price"></div>
        <div class="tagline" id="tagline"></div>

        <ul id="tour-details-list">
          <!-- Tour details will be inserted here -->
        </ul>

        <button id="book-now-btn">ƒê·∫∑t ngay</button>
        <div class="actions">
          <button>üìû G·ªçi mi·ªÖn ph√≠</button>
          <button>üí¨ Li√™n h·ªá t∆∞ v·∫•n</button>
        </div>
      </div>
    </div>


    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <section id="additional-info" style="margin-top: 40px">
      <h2 style="text-align: center; font-weight: bold; margin-bottom: 20px">
        TH√îNG TIN TH√äM V·ªÄ CHUY·∫æN ƒêI
      </h2>
      <div
        id="additional-info-content"
        style="
          display: flex;
          justify-content: space-around;
          flex-wrap: wrap;
          gap: 20px;
        "
      >
        <!-- Dynamic additional info content will be inserted here -->
      </div>
    </section>

    <div
      style="
        display: flex;
        gap: 40px;
        margin-top: 40px;
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
        justify-content: center;
        align-items: flex-start;
      "
    >
      <!-- L·ªãch tr√¨nh Section -->
      <section id="itinerary" style="flex: 1; max-width: 400px">
        <h2 style="text-align: center; font-weight: bold; margin-bottom: 20px">
          L·ªäCH TR√åNH
        </h2>
        <div id="itinerary-list" style="max-width: 100%; margin: 0 auto">
          <!-- C√°c ng√†y l·ªãch tr√¨nh s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
        </div>
      </section>

      <!-- ƒê√°nh gi√° tour -->
      <section id="review-section" style="flex: 1; max-width: 400px">
        <h2 style="text-align: center; font-weight: bold; margin-bottom: 20px">
          ƒê√ÅNH GI√Å TOUR
        </h2>
        <div
          id="review-list"
          style="
            min-height: 100px;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #fff;
          "
        >
          <!-- Danh s√°ch ƒë√°nh gi√° s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
        </div>
      </section>
    </div>

    <style>
      .itinerary-day {
        background-color: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 10px;
        padding: 15px 20px;
        cursor: pointer;
        box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
      }
      .itinerary-day-header {
        display: flex;
        justify-content: space-between;
        font-weight: bold;
        font-size: 1.1rem;
      }
      .itinerary-day-content {
        margin-top: 10px;
        display: none;
        font-size: 0.95rem;
        color: #555;
      }
      .itinerary-day-content p {
        margin: 5px 0;
      }
      .itinerary-day .fa-chevron-down {
        transition: transform 0.3s ease;
      }
      .itinerary-day.expanded .fa-chevron-down {
        transform: rotate(180deg);
      }
      .meal-info {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.9rem;
        color: #333;
        margin-top: 5px;
      }
    </style>

    <script>
      async function loadReviews(tourId) {
        console.log("loadReviews called with tourId:", tourId);
        const reviewList = document.getElementById("review-list");

        if (!tourId) {
          reviewList.innerHTML =
            "<p>Kh√¥ng t√¨m th·∫•y m√£ tour ƒë·ªÉ t·∫£i ƒë√°nh gi√°.</p>";
          return;
        }

        try {
          const response = await fetch(`/api/reviews/${tourId}`);
          if (!response.ok) {
            reviewList.innerHTML =
              "<p>L·ªói khi t·∫£i ƒë√°nh gi√° (response not OK).</p>";
            return;
          }

          const data = await response.json();
          const reviews = Array.isArray(data) ? data : data.data || [];

          if (!Array.isArray(reviews) || reviews.length === 0) {
            reviewList.innerHTML = "<p>Ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</p>";
            return;
          }

          const reviewHtml = reviews
            .map((r, index) => {
              console.log(`Review ${index}:`, r);
              return `
      <div style="border-bottom: 1px solid #ccc; padding: 10px 0;">
        <strong>${r.CustomerName}</strong>
        ƒê√°nh gi√°: ${r.Rating} sao<br/>
        B√¨nh lu·∫≠n: ${r.Comment || "Kh√¥ng c√≥ b√¨nh lu·∫≠n"}
      </div>
    `;
            })
            .join("");
          reviewList.innerHTML = reviewHtml;
        } catch (error) {
          console.error("L·ªói khi g·ªçi API:", error);
          reviewList.innerHTML = "<p>L·ªói khi t·∫£i ƒë√°nh gi√°.</p>";
        }
      }
      function renderItinerary(itineraries) {
        const container = document.getElementById("itinerary-list");
        container.innerHTML = "";
        if (!itineraries || itineraries.length === 0) {
          container.innerHTML = "<p>Ch∆∞a c√≥ l·ªãch tr√¨nh cho tour n√†y.</p>";
          return;
        }
        itineraries.forEach((item, index) => {
          const dayDiv = document.createElement("div");
          dayDiv.className = "itinerary-day";
          dayDiv.innerHTML = `
        <div class="itinerary-day-header">
          <div>
            <strong>Ng√†y ${item.day}:</strong> ${
            item.Title && item.Title.trim() !== ""
              ? item.Title
              : "Ch∆∞a c·∫≠p nh·∫≠t"
          }
          </div>
          <div>
            <i class="fa-solid fa-utensils"></i> ${
              item.meals ? item.meals : "Ch∆∞a c·∫≠p nh·∫≠t"
            }
            <i class="fa-solid fa-chevron-down" style="margin-left: 10px;"></i>
          </div>
        </div>
        <div class="itinerary-day-content">
          <p>${item.details}</p>
        </div>
      `;
          dayDiv.addEventListener("click", () => {
            dayDiv.classList.toggle("expanded");
            const content = dayDiv.querySelector(".itinerary-day-content");
            if (content.style.display === "block") {
              content.style.display = "none";
            } else {
              content.style.display = "block";
            }
          });
          container.appendChild(dayDiv);
        });
      }

      window.onload = async () => {
        try {
          const tourId = new URLSearchParams(window.location.search).get("tourId");
          console.log("window.onload tourId:", tourId);
          if (!tourId) {
            alert("Kh√¥ng t√¨m th·∫•y m√£ tour.");
            return;
          }
          await loadTourDetails();
          await loadReviews(tourId);
        } catch (error) {
          console.error("L·ªói trong window.onload:", error);
        }
      };
    </script>

    <!-- It is recommended to replace /path/to/icon-*.svg with actual icon paths or use icon fonts -->

    <script>
      document
        .getElementById("book-now-btn")
        .addEventListener("click", async () => {
          const urlParams = new URLSearchParams(window.location.search);
          const tourId = urlParams.get("tourId");
          if (!tourId) {
            alert("Kh√¥ng t√¨m th·∫•y m√£ tour ƒë·ªÉ ƒë·∫∑t.");
            return;
          }
          try {
            const res = await fetch("/api/check-login");
            const data = await res.json();
            if (!data.loggedIn) {
              alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c.");
              if (
                confirm("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p t√†i kho·∫£n kh√°ch h√†ng ƒë·ªÉ ƒë·∫∑t tour.")
              ) {
                window.location.href = "/account/login";
              }
              return;
            } else if (data.role !== "customer") {
              alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p t√†i kho·∫£n kh√°ch h√†ng ƒë·ªÉ ƒë·∫∑t tour.");
            } else {
              window.location.href = `/thongtin_thanhtoan?tourId=${encodeURIComponent(
                tourId
              )}`;
            }
          } catch (error) {
            alert("L·ªói ki·ªÉm tra ƒëƒÉng nh·∫≠p. Vui l√≤ng th·ª≠ l·∫°i.");
            console.error(error);
          }
        });
    </script>

    <script>
      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      async function loadTourDetails() {
        const tourId = getQueryParam("tourId");
        if (!tourId) {
          alert("Kh√¥ng t√¨m th·∫•y m√£ tour.");
          return;
        }

        try {
          const res = await fetch(`/api/tours/${tourId}`);
          if (!res.ok) {
            alert("Kh√¥ng t√¨m th·∫•y tour.");
            return;
          }
          const tour = await res.json();

          // L∆∞u d·ªØ li·ªáu tour v√†o bi·∫øn to√†n c·ª•c ƒë·ªÉ d√πng khi m·ªü modal
          window.tourData = tour;

          document.getElementById("tour-title").textContent = tour.tour.TenTour;
          document.getElementById("main-image").src = tour.tour.HinhAnh;
          document.getElementById("main-image").alt = tour.tour.TenTour;

          document.getElementById("tour-price").textContent = `Gi√°: ${Number(
            tour.tour.Gia
          ).toLocaleString()} VNƒê`;
          document.getElementById("old-price").textContent = ""; 
          document.getElementById("tagline").textContent = ""; 

          const detailsList = document.getElementById("tour-details-list");


          let departureDateText = "Ch∆∞a c√≥ d·ªØ li·ªáu";
          let durationText = "Ch∆∞a c√≥ d·ªØ li·ªáu";
          if (tour.flights && tour.flights.length > 0) {
            const firstFlight = tour.flights[0];
            if (firstFlight.DepartureDate) {
              const departureDate = new Date(firstFlight.DepartureDate);
              departureDateText = departureDate.toLocaleDateString("vi-VN");
            }
            if (firstFlight.DepartureDate && firstFlight.ReturnDate) {
              const departureDate = new Date(firstFlight.DepartureDate);
              const returnDate = new Date(firstFlight.ReturnDate);
              const diffTime = Math.abs(returnDate - departureDate);
              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
              durationText = diffDays + " ng√†y";
            }
          }

          detailsList.innerHTML = `
        <li>üÜî M√£ tour: ${tour.tour.TourID}</li>
        <li>üìç ƒêi·ªÉm ƒë·∫øn: ${tour.tour.Destination}</li>
        <li>üë• S·ªë ch·ªó c√≤n: ${tour.tour.SoCho}</li>
        <li>üìÖ Ng√†y kh·ªüi h√†nh: ${departureDateText}</li>
        <li>‚è±Ô∏è Th·ªùi gian: ${durationText}</li>
      `;

          const additionalInfoContent = document.getElementById(
            "additional-info-content"
          );
          additionalInfoContent.innerHTML = `
        <div style="flex: 1 1 200px; border: 1px solid #ddd; border-radius: 8px; padding: 15px; background-color: #fff;">
          <h3><i class="fa-solid fa-map-location-dot"></i> ƒêi·ªÉm Tham Quan</h3>
          <p>${tour.tour.DiemThamQuan || "Ch∆∞a c·∫≠p nh·∫≠t"}</p>
        </div>
        <div style="flex: 1 1 200px; border: 1px solid #ddd; border-radius: 8px; padding: 15px; background-color: #fff;">
          <h3><i class="fa-solid fa-utensils"></i> ·∫®m Th·ª±c</h3>
          <p>${tour.tour.AmThuc || "Ch∆∞a c·∫≠p nh·∫≠t"}</p>
        </div>
        <div style="flex: 1 1 200px; border: 1px solid #ddd; border-radius: 8px; padding: 15px; background-color: #fff;">
          <h3><i class="fa-solid fa-users"></i> ƒê·ªëi T∆∞·ª£ng Th√≠ch H·ª£p</h3>
          <p>${tour.tour.DoiTuongThichHop || "Ch∆∞a c·∫≠p nh·∫≠t"}</p>
        </div>
        <div style="flex: 1 1 200px; border: 1px solid #ddd; border-radius: 8px; padding: 15px; background-color: #fff;">
          <h3><i class="fa-solid fa-clock"></i> Th·ªùi Gian L√Ω T∆∞·ªüng</h3>
          <p>${tour.tour.ThoiGianLyTuong || "Ch∆∞a c·∫≠p nh·∫≠t"}</p>
        </div>
        <div style="flex: 1 1 200px; border: 1px solid #ddd; border-radius: 8px; padding: 15px; background-color: #fff;">
          <h3><i class="fa-solid fa-bus"></i> Ph∆∞∆°ng Ti·ªán</h3>
          <p>${tour.tour.PhuongTien || "Ch∆∞a c·∫≠p nh·∫≠t"}</p>
        </div>
        <div style="flex: 1 1 200px; border: 1px solid #ddd; border-radius: 8px; padding: 15px; background-color: #fff;">
          <h3><i class="fa-solid fa-tag"></i> Khuy·∫øn M√£i</h3>
          <p>${tour.tour.KhuyenMai || "Ch∆∞a c·∫≠p nh·∫≠t"}</p>
        </div>
      `;

          renderItinerary(tour.itineraries);
        } catch (error) {
          alert("L·ªói khi t·∫£i chi ti·∫øt tour.");
          console.error(error);
        }
      }

      window.onload = () => {
        loadTourDetails();
      };
    </script>
  </body>
</html>
