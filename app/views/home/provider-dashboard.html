<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Provider Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="flex h-screen bg-gray-100">
    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-md p-4">
      <h2 class="text-2xl font-bold mb-6 text-blue-600">Provider Panel</h2>
      <nav class="flex flex-col gap-4">
        <button
          class="tab-btn text-left text-gray-700 hover:text-blue-600"
          data-tab="addTour"
        >
          ‚ûï Th√™m Tour
        </button>
        <button
          class="tab-btn text-left text-gray-700 hover:text-blue-600"
          data-tab="manageTour"
        >
          ‚úèÔ∏è Qu·∫£n l√Ω Tour
        </button>
        <button
          class="tab-btn text-left text-gray-700 hover:text-blue-600"
          data-tab="viewOrders"
        >
          üßæ Xem ƒê∆°n ƒê·∫∑t
        </button>
        <button
          class="tab-btn text-left text-gray-700 hover:text-blue-600"
          data-tab="confirmTour"
        >
          üì• X√°c Nh·∫≠n Tour
        </button>
        <button
          class="tab-btn text-left text-gray-700 hover:text-blue-600"
          data-tab="manageServices"
        >
          üß≥ Qu·∫£n l√Ω KS / V√© MB
        </button>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 overflow-y-auto">
      <!-- Th√™m Tour -->
      <section id="addTour" class="tab-content">
        <h2 class="text-xl font-bold mb-4">‚ûï Th√™m Tour M·ªõi</h2>

        <form
          id="addTourForm"
          class="grid grid-cols-1 md:grid-cols-2 gap-4"
          enctype="multipart/form-data"
          method="POST"
        >
          <input
            type="text"
            name="tourName"
            placeholder="T√™n tour"
            class="p-2 border rounded"
            required
          />
          <input
            type="text"
            name="destination"
            placeholder="ƒêi·ªÉm ƒë·∫øn"
            class="p-2 border rounded"
            required
          />
          <input
            type="number"
            name="price"
            placeholder="Gi√°"
            class="p-2 border rounded"
            required
          />
          <input
            type="number"
            name="seats"
            placeholder="S·ªë ch·ªó"
            class="p-2 border rounded"
            required
          />
          <input type="file" name="tourImage" accept="image/*" required />

          <button
            type="submit"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 col-span-1 md:col-span-2"
          >
            Th√™m Tour
          </button>

          <p
            id="tourMessage"
            class="col-span-1 md:col-span-2 font-semibold hidden"
          ></p>
        </form>
      </section>

      <!-- Qu·∫£n l√Ω Tour -->
      <section id="manageTour" class="tab-content hidden p-4">
        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
          <span>‚úèÔ∏è Qu·∫£n l√Ω Tour</span>
        </h2>
        <p class="mb-6 text-gray-600">
          Danh s√°ch tour s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y v·ªõi n√∫t ch·ªânh s·ª≠a, ·∫©n/hi·ªán, c·∫≠p
          nh·∫≠t s·ªë ch·ªó c√≤n l·∫°i.
        </p>

        <div class="overflow-x-auto">
          <table
            class="min-w-full border border-gray-300 rounded-lg overflow-hidden"
          >
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2 border">T√™n Tour</th>
                <th class="px-4 py-2 border">ƒêi·ªÉm ƒë·∫øn</th>
                <th class="px-4 py-2 border">Gi√°</th>
                <th class="px-4 py-2 border">S·ªë ch·ªó c√≤n l·∫°i</th>
                <th class="px-4 py-2 border">·∫¢nh</th>
                <th class="px-4 py-2 border">Thao t√°c</th>
              </tr>
            </thead>
            <tbody id="tourList" class="text-center">
              <!-- C√°c tour s·∫Ω ƒë∆∞·ª£c th√™m ·ªü ƒë√¢y b·∫±ng JS -->
            </tbody>
          </table>
        </div>
      </section>
      <div
        id="editTourModal"
        class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50"
      >
        <div class="bg-white p-6 rounded-lg w-[400px]">
          <h2 class="text-xl font-bold mb-4">‚úèÔ∏è Ch·ªânh s·ª≠a Tour</h2>
          <form id="editTourForm" class="flex flex-col gap-4">
            <input
              type="text"
              id="editTourName"
              class="border p-2 rounded"
              placeholder="T√™n Tour"
              required
            />
            <input
              type="text"
              id="editDestination"
              class="border p-2 rounded"
              placeholder="ƒêi·ªÉm ƒë·∫øn"
              required
            />
            <input
              type="number"
              id="editPrice"
              class="border p-2 rounded"
              placeholder="Gi√°"
              required
            />
            <input
              type="number"
              id="editSeats"
              class="border p-2 rounded"
              placeholder="S·ªë ch·ªó c√≤n l·∫°i"
              required
            />

            <div class="flex justify-end gap-2">
              <button
                type="button"
                id="cancelEdit"
                class="bg-gray-400 hover:bg-gray-500 text-white py-1 px-4 rounded"
              >
                H·ªßy
              </button>
              <button
                type="submit"
                class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-4 rounded"
              >
                L∆∞u
              </button>
            </div>
          </form>
        </div>
      </div>
      <!-- Xem ƒë∆°n ƒë·∫∑t -->
      <section id="viewOrders" class="tab-content hidden">
        <h2 class="text-xl font-bold mb-4">üßæ Xem ƒê∆°n ƒê·∫∑t</h2>
        <p>Hi·ªÉn th·ªã c√°c ƒë∆°n h√†ng/tour ƒë√£ ƒë∆∞·ª£c ng∆∞·ªùi d√πng ƒë·∫∑t.</p>
      </section>

      <!-- X√°c nh·∫≠n tour -->
      <section id="confirmTour" class="tab-content hidden">
        <h2 class="text-xl font-bold mb-4">üì• X√°c Nh·∫≠n Tour</h2>
        <p>G·ª≠i x√°c nh·∫≠n th·ªß c√¥ng ƒë·∫øn kh√°ch ƒë·∫∑t n·∫øu c·∫ßn.</p>
      </section>

      <!-- Qu·∫£n l√Ω KS / V√© MB -->
      <section id="manageServices" class="tab-content hidden">
        <h2 class="text-xl font-bold mb-4">
          üß≥ Qu·∫£n l√Ω Kh√°ch s·∫°n / V√© M√°y Bay
        </h2>
        <p>Cho ph√©p th√™m, ch·ªânh s·ª≠a kh√°ch s·∫°n ho·∫∑c v√© m√°y bay ƒëi k√®m tour.</p>
      </section>
    </main>

    <!-- Script -->
    <script>
      // ƒê·ªïi tab
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tab = btn.getAttribute("data-tab");
          document
            .querySelectorAll(".tab-content")
            .forEach((el) => el.classList.add("hidden"));
          document.getElementById(tab).classList.remove("hidden");
        });
      });

      // Submit Th√™m Tour
      document
        .getElementById("addTourForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const form = e.target;
          const formData = new FormData(form);
          const messageBox = document.getElementById("tourMessage");

          try {
            const res = await fetch("/provider/add-tour", {
              method: "POST",
              body: formData,
            });

            const text = await res.text();
            console.log("Server tr·∫£ v·ªÅ:", text);

            messageBox.classList.remove("hidden");

            if (res.ok) {
              messageBox.innerText = "‚úÖ Tour ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng!";
              messageBox.classList.remove("text-red-600");
              messageBox.classList.add("text-green-600");
              form.reset();
            } else {
              messageBox.innerText = "‚ùå Th√™m tour th·∫•t b·∫°i!";
              messageBox.classList.remove("text-green-600");
              messageBox.classList.add("text-red-600");
            }
          } catch (err) {
            console.error("L·ªói fetch:", err);
            messageBox.innerText = "‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server.";
            messageBox.classList.remove("text-green-600");
            messageBox.classList.add("text-red-600");
            messageBox.classList.remove("hidden");
          }
        });

      async function fetchTours() {
        try {
          const response = await fetch("/provider/tours");
          const tours = await response.json();

          const tourList = document.getElementById("tourList");
          tourList.innerHTML = ""; // Clear previous content

          tours.forEach((tour) => {
            const tourRow = document.createElement("tr");
            tourRow.classList.add("hover:bg-gray-100");

            tourRow.innerHTML = `
        <td class="px-4 py-2 border tourName">${tour.TourName}</td>
        <td class="px-4 py-2 border destination">${tour.Destination}</td>
        <td class="px-4 py-2 border price">${tour.Price}</td>
        <td class="px-4 py-2 border seats">${tour.SoCho}</td>
        <td class="px-4 py-2 border">
          <img src="${tour.ImageURL}" alt="${tour.TourName}" class="w-16 h-16 object-cover rounded">
        </td>
        <td class="px-4 py-2 border">
          <button class="edit-tour-btn bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-3 rounded mr-2">Ch·ªânh s·ª≠a</button>
          <button class="delete-tour-btn bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded">X√≥a</button>
        </td>
      `;

            tourList.appendChild(tourRow);
          });
        } catch (error) {
          console.error("L·ªói khi l·∫•y danh s√°ch tour:", error);
        }
      }

      fetchTours();
      let selectedTourID = null;
      // S·ª± ki·ªán ch·ªânh s·ª≠a tour
      document.addEventListener("click", function (e) {
        if (e.target.classList.contains("edit-tour-btn")) {
          const row = e.target.closest("tr");
          selectedTourID = row.querySelector(".tourID").innerText;
          const tourName = row.querySelector(".tourName").innerText;
          const destination = row.querySelector(".destination").innerText;
          const price = row.querySelector(".price").innerText;
          const seats = row.querySelector(".seats").innerText;

          // M·ªü form ch·ªânh s·ª≠a v·ªõi d·ªØ li·ªáu hi·ªán t·∫°i
          document.getElementById("editTourForm").style.display = "block";
          document.getElementById("editTourName").value = tourName;
          document.getElementById("editDestination").value = destination;
          document.getElementById("editPrice").value = price;
          document.getElementById("editSeats").value = seats;
        }
      });

      // G·∫Øn 1 l·∫ßn duy nh·∫•t khi load trang
      document
        .getElementById("editTourForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const tourName = document.getElementById("editTourName").value;
          const destination = document.getElementById("editDestination").value;
          const price = document.getElementById("editPrice").value;
          const seats = document.getElementById("editSeats").value;

          try {
            const res = await fetch(`/provider/edit-tour/${selectedTourID}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                TourName: tourName,
                Destination: destination,
                Price: price,
                SoCho: seats,
              }),
            });

            const text = await res.text();
            console.log(text);

            if (res.ok) {
              alert("‚úÖ Tour ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!");
              location.reload();
            } else {
              alert("‚ùå Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tour.");
            }
          } catch (err) {
            console.error("L·ªói khi ch·ªânh s·ª≠a tour:", err);
          }
        });

      // S·ª± ki·ªán x√≥a tour
      document.addEventListener("click", async function (e) {
        if (e.target.classList.contains("delete-tour-btn")) {
          const row = e.target.closest("tr");
          const tourID = row.querySelector(".tourID").innerText;

          if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a tour n√†y?")) {
            try {
              const res = await fetch(`/provider/delete-tour/${tourID}`, {
                method: "DELETE",
              });

              const text = await res.text();
              console.log(text);

              if (res.ok) {
                alert("Tour ƒë√£ ƒë∆∞·ª£c x√≥a!");
                row.remove(); // X√≥a tour kh·ªèi b·∫£ng
              } else {
                alert("Kh√¥ng th·ªÉ x√≥a tour.");
              }
            } catch (err) {
              console.error("L·ªói khi x√≥a tour:", err);
            }
          }
        }
      });
      let currentEditingTourID = null;

      // G·ªçi khi b·∫•m v√†o n√∫t "Ch·ªânh s·ª≠a"
      document.addEventListener("click", function (e) {
        if (e.target.classList.contains("edit-tour-btn")) {
          const row = e.target.closest("tr");

          currentEditingTourID = row
            .querySelector(".tourName")
            .innerText.trim(); // ID b·∫°n c·∫ßn t√πy ch·ªânh n·∫øu kh√°c

          document.getElementById("editTourName").value = row
            .querySelector(".tourName")
            .innerText.trim();
          document.getElementById("editDestination").value = row
            .querySelector(".destination")
            .innerText.trim();
          document.getElementById("editPrice").value = row
            .querySelector(".price")
            .innerText.trim();
          document.getElementById("editSeats").value = row
            .querySelector(".seats")
            .innerText.trim();

          document.getElementById("editTourModal").classList.remove("hidden");
          document.getElementById("editTourModal").classList.add("flex");
        }
      });

      // ƒê√≥ng Modal
      document
        .getElementById("cancelEdit")
        .addEventListener("click", function () {
          document.getElementById("editTourModal").classList.add("hidden");
        });

      // Submit Form Ch·ªânh s·ª≠a
      document
        .getElementById("editTourForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = {
            TourName: document.getElementById("editTourName").value,
            Destination: document.getElementById("editDestination").value,
            Price: document.getElementById("editPrice").value,
            SoCho: document.getElementById("editSeats").value,
          };

          try {
            const res = await fetch(
              `/provider/edit-tour/${currentEditingTourID}`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(formData),
              }
            );

            const text = await res.text();
            console.log("K·∫øt qu·∫£ ch·ªânh s·ª≠a:", text);

            if (res.ok) {
              alert("‚úÖ Tour ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!");
              document.getElementById("editTourModal").classList.add("hidden");
              fetchTours(); // T·∫£i l·∫°i danh s√°ch tour sau khi s·ª≠a
            } else {
              alert("‚ùå Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tour.");
            }
          } catch (err) {
            console.error("L·ªói khi ch·ªânh s·ª≠a tour:", err);
          }
        });
    </script>
  </body>
</html>
