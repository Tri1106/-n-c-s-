<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Provider Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="flex h-screen bg-gray-100">
    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-md p-4">
      <h2 class="text-2xl font-bold mb-6 text-blue-600">Provider Panel</h2>
      <nav class="flex flex-col gap-4">
        <button
          class="tab-btn text-left hover:text-blue-600"
          data-tab="addTour"
        >
          ‚ûï Th√™m Tour
        </button>
        <button
          class="tab-btn text-left hover:text-blue-600"
          data-tab="manageTour"
        >
          ‚úèÔ∏è Qu·∫£n l√Ω Tour
        </button>
        <button
          class="tab-btn text-left hover:text-blue-600"
          data-tab="viewOrders"
        >
          üßæ Xem ƒê∆°n ƒê·∫∑t
        </button>
        <button
          class="tab-btn text-left hover:text-blue-600"
          data-tab="confirmTour"
        >
          üì• X√°c Nh·∫≠n Tour
        </button>
        <button
          class="tab-btn text-left hover:text-blue-600"
          data-tab="manageServices"
        >
          üß≥ Qu·∫£n l√Ω KS/V√© MB
        </button>
        <a class="tab-btn text-left hover:text-blue-600" href="/home">ƒêƒÉng Xu·∫•t</a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 overflow-y-auto">
      <!-- Th√™m Tour -->
      <section id="addTour" class="tab-content">
        <h2 class="text-xl font-bold mb-4">‚ûï Th√™m Tour M·ªõi</h2>
        <form
          id="addTourForm"
          class="grid grid-cols-1 md:grid-cols-2 gap-4"
          enctype="multipart/form-data"
          method="POST"
        >
          <input
            type="text"
            name="tourName"
            placeholder="T√™n tour"
            class="p-2 border rounded"
            required
          />
          <input
            type="text"
            name="destination"
            placeholder="ƒêi·ªÉm ƒë·∫øn"
            class="p-2 border rounded"
            required
          />
          <input
            type="number"
            name="price"
            placeholder="Gi√°"
            class="p-2 border rounded"
            required
          />
          <input
            type="number"
            name="seats"
            placeholder="S·ªë ch·ªó"
            class="p-2 border rounded"
            required
          />
          <input
            type="file"
            name="tourImage"
            accept="image/*"
            class="col-span-1 md:col-span-2"
            required
          />
          <button
            type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded col-span-1 md:col-span-2"
          >
            Th√™m Tour
          </button>
          <p
            id="tourMessage"
            class="hidden col-span-1 md:col-span-2 font-semibold"
          ></p>
        </form>
      </section>

      <!-- Qu·∫£n l√Ω Tour -->
      <section id="manageTour" class="tab-content hidden">
        <h2 class="text-2xl font-bold mb-4">‚úèÔ∏è Qu·∫£n l√Ω Tour</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full border">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2 border">T√™n Tour</th>
                <th class="px-4 py-2 border">ƒêi·ªÉm ƒë·∫øn</th>
                <th class="px-4 py-2 border">Gi√°</th>
                <th class="px-4 py-2 border">S·ªë ch·ªó</th>
                <th class="px-4 py-2 border">·∫¢nh</th>
                <th class="px-4 py-2 border">H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody id="tourList" class="text-center">
              <!-- Tour s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS -->
            </tbody>
          </table>
        </div>
      </section>

      <!-- Modal ch·ªânh s·ª≠a -->
      <div
        id="editTourModal"
        class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50"
      >
        <div class="bg-white p-6 rounded-lg w-[400px]">
          <h2 class="text-xl font-bold mb-4">‚úèÔ∏è Ch·ªânh s·ª≠a Tour</h2>
          <form id="editTourForm" class="flex flex-col gap-4">
            <input
              type="text"
              id="editTourName"
              placeholder="T√™n tour"
              class="p-2 border rounded"
              required
            />
            <input
              type="text"
              id="editDestination"
              placeholder="ƒêi·ªÉm ƒë·∫øn"
              class="p-2 border rounded"
              required
            />
            <input
              type="number"
              id="editPrice"
              placeholder="Gi√°"
              class="p-2 border rounded"
              required
            />
            <input
              type="number"
              id="editSeats"
              placeholder="S·ªë ch·ªó"
              class="p-2 border rounded"
              required
            />
            <div class="flex justify-end gap-2">
              <button
                type="button"
                id="cancelEdit"
                class="bg-gray-400 hover:bg-gray-500 text-white py-1 px-4 rounded"
              >
                H·ªßy
              </button>
              <button
                type="submit"
                class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-4 rounded"
              >
                L∆∞u
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- C√°c tab kh√°c -->
      <section id="viewOrders" class="tab-content hidden">
        <h2 class="text-xl font-bold mb-4">üßæ Xem ƒê∆°n ƒê·∫∑t</h2>
        <p>Danh s√°ch ƒë∆°n ƒë·∫∑t tour.</p>
      </section>

      <section id="confirmTour" class="tab-content hidden">
        <h2 class="text-xl font-bold mb-4">üì• X√°c Nh·∫≠n Tour</h2>
        <p>X√°c nh·∫≠n th·ªß c√¥ng ƒë∆°n ƒë·∫∑t tour.</p>
      </section>

      <section id="manageServices" class="tab-content hidden">
        <h2 class="text-xl font-bold mb-4">
          üß≥ Qu·∫£n l√Ω Kh√°ch s·∫°n / V√© m√°y bay
        </h2>
        <p>Th√™m/ch·ªânh s·ª≠a kh√°ch s·∫°n v√† v√© m√°y bay cho tour.</p>
      </section>
    </main>

    <!-- Script -->
    <script>
      let selectedTourID = null;

      // Chuy·ªÉn tab
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;
          document
            .querySelectorAll(".tab-content")
            .forEach((sec) => sec.classList.add("hidden"));
          document.getElementById(tab).classList.remove("hidden");
        });
      });

      // Th√™m Tour
      document
        .getElementById("addTourForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const messageBox = document.getElementById("tourMessage");

          try {
            const res = await fetch("/provider/add-tour", {
              method: "POST",
              body: formData,
            });

            const text = await res.text();
            console.log(text);

            messageBox.classList.remove("hidden");
            if (res.ok) {
              messageBox.innerText = "‚úÖ Th√™m tour th√†nh c√¥ng!";
              messageBox.className =
                "text-green-600 font-semibold col-span-1 md:col-span-2";
              e.target.reset();
              fetchTours(); // Load l·∫°i danh s√°ch
            } else {
              messageBox.innerText = "‚ùå Th√™m tour th·∫•t b·∫°i.";
              messageBox.className =
                "text-red-600 font-semibold col-span-1 md:col-span-2";
            }
          } catch (error) {
            console.error(error);
            messageBox.innerText = "‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi server.";
            messageBox.className =
              "text-red-600 font-semibold col-span-1 md:col-span-2";
          }
        });

      // Load danh s√°ch tour
      async function fetchTours() {
        try {
          const res = await fetch("/provider/tours");
          const tours = await res.json();
          const tourList = document.getElementById("tourList");
          tourList.innerHTML = "";

          tours.forEach((tour) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td class="border px-4 py-2">${tour.TourName}</td>
              <td class="border px-4 py-2">${tour.Destination}</td>
              <td class="border px-4 py-2">${tour.Price}</td>
              <td class="border px-4 py-2">${tour.SoCho}</td>
              <td class="border px-4 py-2">
                <img src="${tour.ImageURL}" alt="Tour Image" class="w-16 h-16 object-cover rounded">
              </td>
              <td class="border px-4 py-2">
                <button class="edit-tour-btn bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-2 rounded mr-2" data-id="${tour.TourID}">Ch·ªânh s·ª≠a</button>
                <button class="delete-tour-btn bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded" data-id="${tour.TourID}">X√≥a</button>
              </td>
            `;
            tourList.appendChild(row);
          });
        } catch (error) {
          console.error("L·ªói khi load tour:", error);
        }
      }
      fetchTours();

      // Ch·ªânh s·ª≠a tour
      document.addEventListener("click", (e) => {
        if (e.target.classList.contains("edit-tour-btn")) {
          selectedTourID = e.target.dataset.id;
          const row = e.target.closest("tr");
          document.getElementById("editTourName").value =
            row.children[0].innerText;
          document.getElementById("editDestination").value =
            row.children[1].innerText;
          document.getElementById("editPrice").value =
            row.children[2].innerText;
          document.getElementById("editSeats").value =
            row.children[3].innerText;
          document.getElementById("editTourModal").classList.remove("hidden");
        }
      });

      document.getElementById("cancelEdit").addEventListener("click", () => {
        document.getElementById("editTourModal").classList.add("hidden");
      });

      document
        .getElementById("editTourForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          try {
            const res = await fetch(`/provider/edit-tour/${selectedTourID}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                tourName: document.getElementById("editTourName").value,
                destination: document.getElementById("editDestination").value,
                price: document.getElementById("editPrice").value,
                seats: document.getElementById("editSeats").value,
              }),
            });

            const text = await res.text();
            console.log(text);

            if (res.ok) {
              alert("‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!");
              document.getElementById("editTourModal").classList.add("hidden");
              fetchTours();
            } else {
              alert("‚ùå Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tour.");
            }
          } catch (err) {
            console.error("L·ªói ch·ªânh s·ª≠a tour:", err);
          }
        });

      // X√≥a tour
      document.addEventListener("click", async (e) => {
        if (e.target.classList.contains("delete-tour-btn")) {
          const id = e.target.dataset.id;
          if (confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a tour n√†y?")) {
            try {
              const res = await fetch(`/provider/delete-tour/${id}`, {
                method: "DELETE",
              });
              const text = await res.text();
              console.log(text);

              if (res.ok) {
                alert("ƒê√£ x√≥a th√†nh c√¥ng!");
                fetchTours();
              } else {
                alert("‚ùå X√≥a th·∫•t b·∫°i.");
              }
            } catch (error) {
              console.error("L·ªói khi x√≥a:", error);
            }
          }
        }
      });
    </script>
  </body>
</html>
