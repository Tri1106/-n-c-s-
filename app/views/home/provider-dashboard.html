<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Provider Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="flex h-screen bg-gray-100">
    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-md p-4">
      <h2 class="text-2xl font-bold mb-6 text-blue-600">Provider Panel</h2>
      <nav class="flex flex-col gap-4">
        <button
          class="tab-btn text-left hover:text-blue-600"
          data-tab="addTour"
        >
          ‚ûï Th√™m Tour
        </button>
        <button
          class="tab-btn text-left hover:text-blue-600"
          data-tab="manageTour"
        >
          ‚úèÔ∏è Qu·∫£n l√Ω Tour
        </button>
        <button
          class="tab-btn text-left hover:text-blue-600"
          data-tab="viewOrders"
        >
          üßæ Xem ƒê∆°n ƒê·∫∑t
        </button>
        <button
          class="tab-btn text-left hover:text-blue-600"
          data-tab="confirmTour"
        >
          üì• X√°c Nh·∫≠n Tour
        </button>
        <button
          class="tab-btn text-left hover:text-blue-600"
          data-tab="manageServices"
        >
          üß≥ Qu·∫£n l√Ω KS/V√© MB
        </button>
        <button
          class="tab-btn text-left hover:text-blue-600"
          data-tab="manageItinerary"
        >
          üìÖ Qu·∫£n l√Ω L·ªãch tr√¨nh
        </button>
        <a class="text-left hover:text-blue-600" href="/home">ƒêƒÉng Xu·∫•t</a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 overflow-y-auto">
      <!-- Th√™m Tour -->
      <section id="addTour" class="tab-content">
        <h2 class="text-xl font-bold mb-4">‚ûï Th√™m Tour M·ªõi</h2>
        <form
          id="addTourForm"
          class="grid grid-cols-1 md:grid-cols-2 gap-4"
          enctype="multipart/form-data"
          method="POST"
          action="/provider/add-tour"
        >
          <input
            type="text"
            name="tourName"
            placeholder="T√™n tour"
            class="p-2 border rounded"
            required
          />
          <input
            type="text"
            name="destination"
            placeholder="ƒêi·ªÉm ƒë·∫øn"
            class="p-2 border rounded"
            required
          />
          <input
            type="number"
            name="price"
            placeholder="Gi√°"
            class="p-2 border rounded"
            required
          />
          <input
            type="number"
            name="seats"
            placeholder="S·ªë ch·ªó"
            class="p-2 border rounded"
            required
          />
          <input
            type="text"
            name="diemThamQuan"
            placeholder="ƒêi·ªÉm tham quan"
            class="p-2 border rounded"
          />
          <input
            type="text"
            name="amThuc"
            placeholder="·∫®m th·ª±c"
            class="p-2 border rounded"
          />
          <input
            type="text"
            name="doiTuongThichHop"
            placeholder="ƒê·ªëi t∆∞·ª£ng th√≠ch h·ª£p"
            class="p-2 border rounded"
          />
          <input
            type="text"
            name="thoiGianLyTuong"
            placeholder="Th·ªùi gian l√Ω t∆∞·ªüng"
            class="p-2 border rounded"
          />
          <input
            type="text"
            name="phuongTien"
            placeholder="Ph∆∞∆°ng ti·ªán"
            class="p-2 border rounded"
          />
          <input
            type="text"
            name="khuyenMai"
            placeholder="Khuy·∫øn m√£i"
            class="p-2 border rounded"
          />
          <input
            type="file"
            name="tourImage"
            accept="image/*"
            class="col-span-1 md:col-span-2"
            required
          />
          <button
            type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded col-span-1 md:col-span-2"
          >
            Th√™m Tour
          </button>
          <p
            id="tourMessage"
            class="hidden col-span-1 md:col-span-2 font-semibold"
          ></p>
        </form>
      </section>

      <!-- Qu·∫£n l√Ω Tour -->
      <section id="manageTour" class="tab-content hidden">
        <h2 class="text-2xl font-bold mb-4">‚úèÔ∏è Qu·∫£n l√Ω Tour</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full border">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2 border">T√™n Tour</th>
                <th class="px-4 py-2 border">ƒêi·ªÉm ƒë·∫øn</th>
                <th class="px-4 py-2 border">Gi√°</th>
                <th class="px-4 py-2 border">S·ªë ch·ªó</th>
                <th class="px-4 py-2 border">·∫¢nh</th>
                <th class="px-4 py-2 border">H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody id="tourList" class="text-center">
              <!-- Tour s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS -->
            </tbody>
          </table>
        </div>
      </section>

      <!-- Modal ch·ªânh s·ª≠a -->
      <div
        id="editTourModal"
        class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50"
      >
        <div class="bg-white p-6 rounded-lg w-[400px]">
          <h2 class="text-xl font-bold mb-4">‚úèÔ∏è Ch·ªânh s·ª≠a Tour</h2>
          <form id="editTourForm" class="flex flex-col gap-4">
          <input
            type="text"
            id="editTourName"
            placeholder="T√™n tour"
            class="p-2 border rounded"
            required
          />
          <input
            type="text"
            id="editDestination"
            placeholder="ƒêi·ªÉm ƒë·∫øn"
            class="p-2 border rounded"
            required
          />
          <input
            type="number"
            id="editPrice"
            placeholder="Gi√°"
            class="p-2 border rounded"
            required
          />
          <input
            type="number"
            id="editSeats"
            placeholder="S·ªë ch·ªó"
            class="p-2 border rounded"
            required
          />
          <input
            type="text"
            id="editDiemThamQuan"
            placeholder="ƒêi·ªÉm tham quan"
            class="p-2 border rounded"
          />
          <input
            type="text"
            id="editAmThuc"
            placeholder="·∫®m th·ª±c"
            class="p-2 border rounded"
          />
          <input
            type="text"
            id="editDoiTuongThichHop"
            placeholder="ƒê·ªëi t∆∞·ª£ng th√≠ch h·ª£p"
            class="p-2 border rounded"
          />
          <input
            type="text"
            id="editThoiGianLyTuong"
            placeholder="Th·ªùi gian l√Ω t∆∞·ªüng"
            class="p-2 border rounded"
          />
          <input
            type="text"
            id="editPhuongTien"
            placeholder="Ph∆∞∆°ng ti·ªán"
            class="p-2 border rounded"
          />
          <input
            type="text"
            id="editKhuyenMai"
            placeholder="Khuy·∫øn m√£i"
            class="p-2 border rounded"
          />
          <div class="flex justify-end gap-2">
            <button
              type="button"
              id="cancelEdit"
              class="bg-gray-400 hover:bg-gray-500 text-white py-1 px-4 rounded"
            >
              H·ªßy
            </button>
            <button
              type="submit"
              class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-4 rounded"
            >
              L∆∞u
            </button>
          </div>
        </form>
        </div>
      </div>

      <!-- C√°c tab kh√°c -->
      <section id="viewOrders" class="tab-content hidden">
      <h2 class="text-xl font-bold mb-4">üßæ Xem ƒê∆°n ƒê·∫∑t</h2>
      <p>Danh s√°ch ƒë∆°n ƒë·∫∑t tour.</p>
    </section>

      <section id="confirmTour" class="tab-content hidden">
        <h2 class="text-xl font-bold mb-4">üì• X√°c Nh·∫≠n Tour</h2>
        <p>X√°c nh·∫≠n th·ªß c√¥ng ƒë∆°n ƒë·∫∑t tour.</p>
      </section>

      <section id="manageItinerary" class="tab-content hidden">
        <h2 class="text-xl font-bold mb-4">üìÖ Qu·∫£n l√Ω L·ªãch tr√¨nh</h2>
        <div class="mb-4">
          <label for="itineraryTourSelect" class="block mb-2 font-semibold">Ch·ªçn Tour:</label>
          <select id="itineraryTourSelect" class="p-2 border rounded w-full max-w-xs">
            <option value="">Ch·ªçn Tour</option>
          </select>
        </div>
        <div id="itineraryList" class="space-y-4 mb-4">
          <p>Vui l√≤ng ch·ªçn tour ƒë·ªÉ xem l·ªãch tr√¨nh.</p>
        </div>
        <button id="addItineraryBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
          Th√™m L·ªãch tr√¨nh
        </button>

        <!-- Modal th√™m/s·ª≠a l·ªãch tr√¨nh -->
        <div id="itineraryModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
          <div class="bg-white p-6 rounded-lg w-[400px]">
            <h2 id="itineraryModalTitle" class="text-xl font-bold mb-4">Th√™m L·ªãch tr√¨nh</h2>
            <form id="itineraryForm" class="flex flex-col gap-4">
              <input type="hidden" id="itineraryID" />
              <label for="dayNumber" class="font-semibold">Ng√†y:</label>
              <input type="number" id="dayNumber" min="1" class="p-2 border rounded" required />
              <label for="title" class="font-semibold">Ti√™u ƒë·ªÅ:</label>
              <input type="text" id="title" class="p-2 border rounded" required />
              <label for="meals" class="font-semibold">B·ªØa ƒÉn:</label>
              <input type="text" id="meals" class="p-2 border rounded" />
              <label for="details" class="font-semibold">Chi ti·∫øt:</label>
              <textarea id="details" rows="3" class="p-2 border rounded"></textarea>
              <div class="flex justify-end gap-2">
                <button type="button" id="cancelItinerary" class="bg-gray-400 hover:bg-gray-500 text-white py-1 px-4 rounded">H·ªßy</button>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-1 px-4 rounded">L∆∞u</button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <section id="manageServices" class="tab-content hidden">
        <h2 class="text-xl font-bold mb-4">üß≥ Qu·∫£n l√Ω KS/V√© MB</h2>
        <div class="mb-4">
          <label for="serviceTourSelect" class="block mb-2 font-semibold">Ch·ªçn Tour:</label>
          <select id="serviceTourSelect" class="p-2 border rounded w-full max-w-xs">
            <option value="">Ch·ªçn Tour</option>
          </select>
        </div>

        <!-- Form th√™m kh√°ch s·∫°n -->
        <div class="mb-6 border p-4 rounded bg-white shadow">
          <h3 class="text-lg font-semibold mb-2">Th√™m Kh√°ch s·∫°n</h3>
          <form id="addHotelForm" enctype="multipart/form-data">
            <div class="mb-2">
              <label for="hotelTourSelect" class="block font-semibold mb-1">Ch·ªçn Tour:</label>
              <select id="hotelTourSelect" name="tourID" class="p-2 border rounded w-full max-w-xs" required>
                <option value="">Ch·ªçn Tour</option>
              </select>
            </div>
            <div class="mb-2">
              <input type="text" name="hotelName" placeholder="T√™n kh√°ch s·∫°n" class="p-2 border rounded w-full max-w-xs" required />
            </div>
            <div class="mb-2">
              <input type="text" name="location" placeholder="ƒê·ªãa ƒëi·ªÉm" class="p-2 border rounded w-full max-w-xs" required />
            </div>
            <div class="mb-2">
              <input type="number" name="pricePerNight" placeholder="Gi√° m·ªói ƒë√™m" class="p-2 border rounded w-full max-w-xs" required />
            </div>
            <div class="mb-2">
              <input type="file" name="hotelImage" accept="image/*" class="w-full max-w-xs" />
            </div>
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Th√™m Kh√°ch s·∫°n</button>
            <p id="hotelMessage" class="mt-2 font-semibold"></p>
          </form>
        </div>

        <!-- Form th√™m v√© m√°y bay -->
        <div class="mb-6 border p-4 rounded bg-white shadow">
          <h3 class="text-lg font-semibold mb-2">Th√™m V√© M√°y Bay</h3>
          <form id="addFlightForm">
            <div class="mb-2">
              <label for="flightTourSelect" class="block font-semibold mb-1">Ch·ªçn Tour:</label>
              <select id="flightTourSelect" name="tourID" class="p-2 border rounded w-full max-w-xs" required>
                <option value="">Ch·ªçn Tour</option>
              </select>
            </div>
            <div class="mb-2">
              <input type="text" name="airline" placeholder="H√£ng bay" class="p-2 border rounded w-full max-w-xs" required />
            </div>
            <div class="mb-2">
              <input type="text" name="departurePoint" placeholder="ƒêi·ªÉm ƒëi" class="p-2 border rounded w-full max-w-xs" required />
            </div>
            <div class="mb-2">
              <input type="text" name="destinationPoint" placeholder="ƒêi·ªÉm ƒë·∫øn" class="p-2 border rounded w-full max-w-xs" required />
            </div>
            <div class="mb-2">
              <input type="number" name="flightPrice" placeholder="Gi√° v√©" class="p-2 border rounded w-full max-w-xs" required />
            </div>
            <div class="mb-2">
              <label for="departTime" class="block font-semibold mb-1">Th·ªùi gian kh·ªüi h√†nh:</label>
              <input type="datetime-local" name="departTime" id="departTime" class="p-2 border rounded w-full max-w-xs" required />
            </div>
            <div class="mb-2">
              <label for="returnTime" class="block font-semibold mb-1">Th·ªùi gian v·ªÅ:</label>
              <input type="datetime-local" name="returnTime" id="returnTime" class="p-2 border rounded w-full max-w-xs" required />
            </div>
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Th√™m V√© M√°y Bay</button>
            <p id="flightMessage" class="mt-2 font-semibold"></p>
          </form>
        </div>

        <div id="serviceList" class="space-y-4">
          <p>Vui l√≤ng ch·ªçn tour ƒë·ªÉ xem d·ªãch v·ª• kh√°ch s·∫°n v√† v√© m√°y bay.</p>
        </div>
      </section>

      <script>
        // Load danh s√°ch tour cho dropdown ch·ªçn l·ªãch tr√¨nh
        async function loadItineraryTours() {
          try {
            const res = await fetch("/provider/tours");
            const tours = await res.json();
            const select = document.getElementById("itineraryTourSelect");
            select.innerHTML = '<option value="">Ch·ªçn Tour</option>';
            tours.forEach((tour) => {
              const option = document.createElement("option");
              option.value = tour.TourID;
              option.textContent = tour.TourName;
              select.appendChild(option);
            });
          } catch (error) {
            console.error("L·ªói khi t·∫£i danh s√°ch tour cho l·ªãch tr√¨nh:", error);
          }
        }

        // Load danh s√°ch l·ªãch tr√¨nh theo tour
        async function loadItineraries(tourID) {
          if (!tourID) {
            document.getElementById("itineraryList").innerHTML = "<p>Vui l√≤ng ch·ªçn tour.</p>";
            return;
          }
          try {
            const res = await fetch(`/provider/itineraries/${tourID}`);
            if (!res.ok) {
              throw new Error("L·ªói khi l·∫•y l·ªãch tr√¨nh");
            }
            const itineraries = await res.json();
            const container = document.getElementById("itineraryList");
            container.innerHTML = "";
            if (itineraries.length === 0) {
              container.innerHTML = "<p>Ch∆∞a c√≥ l·ªãch tr√¨nh cho tour n√†y.</p>";
              return;
            }
            itineraries.forEach((item) => {
              const div = document.createElement("div");
              div.className = "border p-4 rounded flex justify-between items-center";
              div.innerHTML = `
                <div>
                  <p><strong>Ng√†y:</strong> ${item.DayNumber}</p>
                  <p><strong>Ti√™u ƒë·ªÅ:</strong> ${item.Title}</p>
                  <p><strong>B·ªØa ƒÉn:</strong> ${item.Meals || ""}</p>
                  <p><strong>Chi ti·∫øt:</strong> ${item.Details || ""}</p>
                </div>
                <div class="flex gap-2">
                  <button class="edit-itinerary-btn bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-3 rounded" data-id="${item.ItineraryID}">S·ª≠a</button>
                  <button class="delete-itinerary-btn bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded" data-id="${item.ItineraryID}">X√≥a</button>
                </div>
              `;
              container.appendChild(div);
            });
          } catch (error) {
            console.error(error);
            document.getElementById("itineraryList").innerHTML = "<p>L·ªói khi t·∫£i l·ªãch tr√¨nh.</p>";
          }
        }

        // Hi·ªÉn th·ªã modal th√™m/s·ª≠a l·ªãch tr√¨nh
        function showItineraryModal(edit = false, data = null) {
          const modal = document.getElementById("itineraryModal");
          const title = document.getElementById("itineraryModalTitle");
          const form = document.getElementById("itineraryForm");
          if (edit && data) {
            title.textContent = "S·ª≠a L·ªãch tr√¨nh";
            document.getElementById("itineraryID").value = data.ItineraryID;
            document.getElementById("dayNumber").value = data.DayNumber;
            document.getElementById("title").value = data.Title;
            document.getElementById("meals").value = data.Meals || "";
            document.getElementById("details").value = data.Details || "";
          } else {
            title.textContent = "Th√™m L·ªãch tr√¨nh";
            form.reset();
            document.getElementById("itineraryID").value = "";
          }
          modal.classList.remove("hidden");
        }

        // ·∫®n modal
        document.getElementById("cancelItinerary").addEventListener("click", () => {
          document.getElementById("itineraryModal").classList.add("hidden");
        });

        // X·ª≠ l√Ω submit form th√™m/s·ª≠a l·ªãch tr√¨nh
        document.getElementById("itineraryForm").addEventListener("submit", async (e) => {
          e.preventDefault();
          const itineraryID = document.getElementById("itineraryID").value;
          const tourID = document.getElementById("itineraryTourSelect").value;
          if (!tourID) {
            alert("Vui l√≤ng ch·ªçn tour.");
            return;
          }
          const dayNumber = document.getElementById("dayNumber").value;
          const title = document.getElementById("title").value;
          const meals = document.getElementById("meals").value;
          const details = document.getElementById("details").value;

          try {
            let res;
            if (itineraryID) {
              // S·ª≠a l·ªãch tr√¨nh
              res = await fetch(`/provider/edit-itinerary/${itineraryID}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ dayNumber, title, meals, details }),
              });
            } else {
              // Th√™m l·ªãch tr√¨nh
              res = await fetch("/provider/add-itinerary", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ tourID, dayNumber, title, meals, details }),
              });
            }
            if (res.ok) {
              alert(itineraryID ? "C·∫≠p nh·∫≠t l·ªãch tr√¨nh th√†nh c√¥ng!" : "Th√™m l·ªãch tr√¨nh th√†nh c√¥ng!");
              document.getElementById("itineraryModal").classList.add("hidden");
              loadItineraries(tourID);
            } else {
              alert("L·ªói khi l∆∞u l·ªãch tr√¨nh.");
            }
          } catch (error) {
            console.error(error);
            alert("L·ªói khi l∆∞u l·ªãch tr√¨nh.");
          }
        });

        // X·ª≠ l√Ω click n√∫t th√™m l·ªãch tr√¨nh
        document.getElementById("addItineraryBtn").addEventListener("click", () => {
          showItineraryModal(false);
        });

        // X·ª≠ l√Ω click n√∫t s·ª≠a l·ªãch tr√¨nh
        document.addEventListener("click", async (e) => {
          if (e.target.classList.contains("edit-itinerary-btn")) {
            const id = e.target.dataset.id;
            try {
              const res = await fetch(`/provider/itineraries/${document.getElementById("itineraryTourSelect").value}`);
              if (!res.ok) throw new Error("L·ªói khi l·∫•y l·ªãch tr√¨nh");
              const itineraries = await res.json();
              const itinerary = itineraries.find((item) => item.ItineraryID === id);
              if (itinerary) {
                showItineraryModal(true, itinerary);
              }
            } catch (error) {
              console.error(error);
              alert("L·ªói khi t·∫£i d·ªØ li·ªáu l·ªãch tr√¨nh.");
            }
          }
        });

        // X·ª≠ l√Ω click n√∫t x√≥a l·ªãch tr√¨nh
        document.addEventListener("click", async (e) => {
          if (e.target.classList.contains("delete-itinerary-btn")) {
            const id = e.target.dataset.id;
            if (confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a l·ªãch tr√¨nh n√†y?")) {
              try {
                const res = await fetch(`/provider/delete-itinerary/${id}`, {
                  method: "DELETE",
                });
                if (res.ok) {
                  alert("X√≥a l·ªãch tr√¨nh th√†nh c√¥ng!");
                  loadItineraries(document.getElementById("itineraryTourSelect").value);
                } else {
                  alert("X√≥a l·ªãch tr√¨nh th·∫•t b·∫°i.");
                }
              } catch (error) {
                console.error(error);
                alert("L·ªói khi x√≥a l·ªãch tr√¨nh.");
              }
            }
          }
        });

        // X·ª≠ l√Ω thay ƒë·ªïi tour ch·ªçn ƒë·ªÉ load l·ªãch tr√¨nh t∆∞∆°ng ·ª©ng
        document.getElementById("itineraryTourSelect").addEventListener("change", (e) => {
          loadItineraries(e.target.value);
        });

        // Kh·ªüi t·∫°o
        loadItineraryTours();

      // Load danh s√°ch tour cho dropdown ch·ªçn tour trong tab Qu·∫£n l√Ω KS/V√© MB
      async function loadServiceTours() {
        try {
          const res = await fetch("/provider/tours");
          if (!res.ok) throw new Error("L·ªói khi t·∫£i danh s√°ch tour");
          const tours = await res.json();
          const select = document.getElementById("serviceTourSelect");
          select.innerHTML = '<option value="">Ch·ªçn Tour</option>';
          tours.forEach((tour) => {
            const option = document.createElement("option");
            option.value = tour.TourID;
            option.textContent = tour.TourName;
            select.appendChild(option);
          });
        } catch (error) {
          console.error("L·ªói khi t·∫£i danh s√°ch tour cho d·ªãch v·ª•:", error);
        }
      }

      // X·ª≠ l√Ω s·ª± ki·ªán ch·ªçn tour trong dropdown serviceTourSelect
      document.getElementById("serviceTourSelect").addEventListener("change", (e) => {
        loadServices(e.target.value);
      });

      // Load danh s√°ch tour cho dropdown ch·ªçn tour trong form th√™m kh√°ch s·∫°n v√† v√© m√°y bay
      async function loadHotelFlightTours() {
        try {
          const res = await fetch("/provider/tours");
          if (!res.ok) throw new Error("L·ªói khi t·∫£i danh s√°ch tour");
          const tours = await res.json();

          const hotelSelect = document.getElementById("hotelTourSelect");
          const flightSelect = document.getElementById("flightTourSelect");

          hotelSelect.innerHTML = '<option value="">Ch·ªçn Tour</option>';
          flightSelect.innerHTML = '<option value="">Ch·ªçn Tour</option>';

          tours.forEach((tour) => {
            const option1 = document.createElement("option");
            option1.value = tour.TourID;
            option1.textContent = tour.TourName;
            hotelSelect.appendChild(option1);

            const option2 = document.createElement("option");
            option2.value = tour.TourID;
            option2.textContent = tour.TourName;
            flightSelect.appendChild(option2);
          });
        } catch (error) {
          console.error("L·ªói khi t·∫£i danh s√°ch tour cho kh√°ch s·∫°n v√† v√© m√°y bay:", error);
        }
      }

      // X·ª≠ l√Ω submit form th√™m kh√°ch s·∫°n
      document.getElementById("addHotelForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);

        try {
          const res = await fetch("/provider/add-hotel", {
            method: "POST",
            body: formData,
          });
          const result = await res.json();
          const messageEl = document.getElementById("hotelMessage");
          if (res.ok) {
            messageEl.textContent = "Th√™m kh√°ch s·∫°n th√†nh c√¥ng!";
            messageEl.classList.remove("text-red-600");
            messageEl.classList.add("text-green-600");
            form.reset();
            loadServices(formData.get("tourID"));
          } else {
            messageEl.textContent = result.message || "L·ªói khi th√™m kh√°ch s·∫°n.";
            messageEl.classList.remove("text-green-600");
            messageEl.classList.add("text-red-600");
          }
        } catch (error) {
          console.error("L·ªói khi th√™m kh√°ch s·∫°n:", error);
          const messageEl = document.getElementById("hotelMessage");
          messageEl.textContent = "L·ªói khi th√™m kh√°ch s·∫°n.";
          messageEl.classList.remove("text-green-600");
          messageEl.classList.add("text-red-600");
        }
      });

      // X·ª≠ l√Ω submit form th√™m v√© m√°y bay
      document.getElementById("addFlightForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);

        try {
          const res = await fetch("/provider/add-flight", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              tourID: formData.get("tourID"),
              airline: formData.get("airline"),
              departurePoint: formData.get("departurePoint"),
              destinationPoint: formData.get("destinationPoint"),
              price: Number(formData.get("flightPrice")),
              departTime: formData.get("departTime"),
              returnTime: formData.get("returnTime"),
            }),
          });
          const result = await res.json();
          const messageEl = document.getElementById("flightMessage");
          if (res.ok) {
            messageEl.textContent = "Th√™m v√© m√°y bay th√†nh c√¥ng!";
            messageEl.classList.remove("text-red-600");
            messageEl.classList.add("text-green-600");
            form.reset();
            loadServices(formData.get("tourID"));
          } else {
            messageEl.textContent = result.message || "L·ªói khi th√™m v√© m√°y bay.";
            messageEl.classList.remove("text-green-600");
            messageEl.classList.add("text-red-600");
          }
        } catch (error) {
          console.error("L·ªói khi th√™m v√© m√°y bay:", error);
          const messageEl = document.getElementById("flightMessage");
          messageEl.textContent = "L·ªói khi th√™m v√© m√°y bay.";
          messageEl.classList.remove("text-green-600");
          messageEl.classList.add("text-red-600");
        }
      });

      // Kh·ªüi t·∫°o load danh s√°ch tour cho form th√™m kh√°ch s·∫°n v√† v√© m√°y bay
      loadHotelFlightTours();

      // X·ª≠ l√Ω s·ª± ki·ªán click chuy·ªÉn tab
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;
          document.querySelectorAll(".tab-content").forEach((sec) => sec.classList.add("hidden"));
          const activeTab = document.getElementById(tab);
          if (activeTab) {
            activeTab.classList.remove("hidden");
            // Load d·ªØ li·ªáu t∆∞∆°ng ·ª©ng khi chuy·ªÉn tab
            if (tab === "manageTour") {
              loadTours();
            } else if (tab === "manageServices") {
              loadServiceTours();
              // Clear serviceList content and reset dropdown on tab open
              document.getElementById("serviceList").innerHTML = '<p>Vui l√≤ng ch·ªçn tour ƒë·ªÉ xem d·ªãch v·ª• kh√°ch s·∫°n v√† v√© m√°y bay.</p>';
              document.getElementById("serviceTourSelect").value = "";
            }
          }
        });
      });

      // H√†m load danh s√°ch tour cho tab Qu·∫£n l√Ω Tour
      async function loadTours() {
        try {
          const res = await fetch("/provider/tours");
          if (!res.ok) throw new Error("L·ªói khi t·∫£i danh s√°ch tour");
          const tours = await res.json();
          const tbody = document.getElementById("tourList");
          tbody.innerHTML = "";
          if (tours.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Ch∆∞a c√≥ tour n√†o.</td></tr>';
            return;
          }
          tours.forEach((tour) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td class="border px-4 py-2">${tour.TourName}</td>
              <td class="border px-4 py-2">${tour.Destination}</td>
              <td class="border px-4 py-2">${tour.Price}</td>
              <td class="border px-4 py-2">${tour.SoCho !== undefined ? tour.SoCho : ''}</td>
              <td class="border px-4 py-2"><img src="${tour.ImageURL || ''}" alt="·∫¢nh tour" class="w-20 h-14 object-cover mx-auto"/></td>
              <td class="border px-4 py-2 text-center">
                <button class="edit-tour-btn bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-3 rounded" data-id="${tour.TourID}">S·ª≠a</button>
                <button class="delete-tour-btn bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded" data-id="${tour.TourID}">X√≥a</button>
              </td>
            `;
            tbody.appendChild(tr);
          });

      // Th√™m event listener cho n√∫t S·ª≠a v√† X√≥a
      document.querySelectorAll(".edit-tour-btn").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          const tourID = e.target.dataset.id;
          try {
            const res = await fetch(`/provider/tours/${tourID}`);
            if (!res.ok) throw new Error("L·ªói khi l·∫•y d·ªØ li·ªáu tour");
            const tour = await res.json();
            // ƒêi·ªÅn d·ªØ li·ªáu v√†o form ch·ªânh s·ª≠a
            document.getElementById("editTourName").value = tour.TourName || "";
            document.getElementById("editDestination").value = tour.Destination || "";
            document.getElementById("editPrice").value = tour.Price || "";
            document.getElementById("editSeats").value = tour.SoCho || "";
            document.getElementById("editDiemThamQuan").value = tour.DiemThamQuan || "";
            document.getElementById("editAmThuc").value = tour.AmThuc || "";
            document.getElementById("editDoiTuongThichHop").value = tour.DoiTuongThichHop || "";
            document.getElementById("editThoiGianLyTuong").value = tour.ThoiGianLyTuong || "";
            document.getElementById("editPhuongTien").value = tour.PhuongTien || "";
            document.getElementById("editKhuyenMai").value = tour.KhuyenMai || "";
            // Hi·ªÉn th·ªã modal ch·ªânh s·ª≠a
            document.getElementById("editTourModal").classList.remove("hidden");
            // L∆∞u tourID v√†o form ƒë·ªÉ g·ª≠i khi l∆∞u
            document.getElementById("editTourForm").dataset.tourId = tourID;
          } catch (error) {
            console.error(error);
            alert("L·ªói khi t·∫£i d·ªØ li·ªáu tour.");
          }
        });
      });

      // X·ª≠ l√Ω submit form ch·ªânh s·ª≠a tour
      document.getElementById("editTourForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const tourID = e.target.dataset.tourId;
        const tourName = document.getElementById("editTourName").value;
        const destination = document.getElementById("editDestination").value;
        const price = parseFloat(document.getElementById("editPrice").value);
        const seats = parseInt(document.getElementById("editSeats").value);
        const diemThamQuan = document.getElementById("editDiemThamQuan").value;
        const amThuc = document.getElementById("editAmThuc").value;
        const doiTuongThichHop = document.getElementById("editDoiTuongThichHop").value;
        const thoiGianLyTuong = document.getElementById("editThoiGianLyTuong").value;
        const phuongTien = document.getElementById("editPhuongTien").value;
        const khuyenMai = document.getElementById("editKhuyenMai").value;

        try {
          const res = await fetch(`/provider/edit-tour/${tourID}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              tourName,
              destination,
              price,
              seats,
              diemThamQuan,
              amThuc,
              doiTuongThichHop,
              thoiGianLyTuong,
              phuongTien,
              khuyenMai,
            }),
          });
          if (res.ok) {
            alert("C·∫≠p nh·∫≠t tour th√†nh c√¥ng!");
            document.getElementById("editTourModal").classList.add("hidden");
            loadTours();
          } else {
            alert("L·ªói khi c·∫≠p nh·∫≠t tour.");
          }
        } catch (error) {
          console.error(error);
          alert("L·ªói khi c·∫≠p nh·∫≠t tour.");
        }
      });

      // Th√™m event listener cho n√∫t Xem chi ti·∫øt
      document.querySelectorAll(".view-details-btn").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const tourID = e.target.dataset.id;
          // Chuy·ªÉn sang tab Qu·∫£n l√Ω KS/V√© MB
          document.querySelectorAll(".tab-content").forEach((sec) => sec.classList.add("hidden"));
          const manageServicesTab = document.getElementById("manageServices");
          if (manageServicesTab) {
            manageServicesTab.classList.remove("hidden");
          }
          // Ch·ªçn tour t∆∞∆°ng ·ª©ng trong dropdown
          const serviceTourSelect = document.getElementById("serviceTourSelect");
          if (serviceTourSelect) {
            serviceTourSelect.value = tourID;
            // G·ªçi h√†m load d·ªãch v·ª• kh√°ch s·∫°n v√† v√© m√°y bay
            if (typeof loadServices === "function") {
              loadServices(tourID);
            }
          }
        });
      });

          document.querySelectorAll(".delete-tour-btn").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              const tourID = e.target.dataset.id;
              if (confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a tour n√†y?")) {
                try {
                  const res = await fetch(`/provider/delete-tour/${tourID}`, {
                    method: "DELETE",
                  });
                  if (res.ok) {
                    alert("X√≥a tour th√†nh c√¥ng!");
                    loadTours();
                  } else {
                    alert("X√≥a tour th·∫•t b·∫°i.");
                  }
                } catch (error) {
                  console.error(error);
                  alert("L·ªói khi x√≥a tour.");
                }
              }
            });
          });

        } catch (error) {
          console.error(error);
          const tbody = document.getElementById("tourList");
          tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-red-600">L·ªói khi t·∫£i danh s√°ch tour.</td></tr>';
        }
      }

      // H√†m load d·ªØ li·ªáu cho tab Qu·∫£n l√Ω KS/V√© MB theo tour ƒë∆∞·ª£c ch·ªçn
      async function loadServices(tourID) {
        if (!tourID) {
          document.getElementById("serviceList").innerHTML = "<p>Vui l√≤ng ch·ªçn tour ƒë·ªÉ xem d·ªãch v·ª• kh√°ch s·∫°n v√† v√© m√°y bay.</p>";
          return;
        }
        try {
          const res = await fetch(`/provider/tour-details/${tourID}`);
          if (!res.ok) throw new Error(`L·ªói khi t·∫£i d·ªØ li·ªáu d·ªãch v·ª•: ${res.status} ${res.statusText}`);
          const data = await res.json();
          const container = document.getElementById("serviceList");
          container.innerHTML = "";
          // Hi·ªÉn th·ªã danh s√°ch kh√°ch s·∫°n
          if (data.hotels && data.hotels.length > 0) {
            const hotelTitle = document.createElement("h3");
            hotelTitle.textContent = "üè® Danh s√°ch Kh√°ch s·∫°n:";
            hotelTitle.className = "font-semibold text-lg mb-2";
            container.appendChild(hotelTitle);
            const ulHotels = document.createElement("ul");
            ulHotels.className = "list-disc pl-6 mb-4";
            data.hotels.forEach((hotel) => {
              const li = document.createElement("li");
              li.textContent = `${hotel.HotelName} - ${hotel.Location} - Gi√°: ${hotel.PricePerNight}`;
              ulHotels.appendChild(li);
            });
            container.appendChild(ulHotels);
          } else {
            const noHotels = document.createElement("p");
            noHotels.textContent = "Ch∆∞a c√≥ kh√°ch s·∫°n n√†o cho tour n√†y.";
            container.appendChild(noHotels);
          }
          // Hi·ªÉn th·ªã danh s√°ch v√© m√°y bay
          if (data.flights && data.flights.length > 0) {
            const flightTitle = document.createElement("h3");
            flightTitle.textContent = "‚úàÔ∏è Danh s√°ch V√© m√°y bay:";
            flightTitle.className = "font-semibold text-lg mb-2";
            container.appendChild(flightTitle);
            const ulFlights = document.createElement("ul");
            ulFlights.className = "list-disc pl-6";
            data.flights.forEach((flight) => {
              const li = document.createElement("li");
              li.textContent = `${flight.Airline} - ${flight.DeparturePoint} ‚Üí ${flight.DestinationPoint} - Gi√°: ${flight.Price}`;
              ulFlights.appendChild(li);
            });
            container.appendChild(ulFlights);
          } else {
            const noFlights = document.createElement("p");
            noFlights.textContent = "Ch∆∞a c√≥ v√© m√°y bay n√†o cho tour n√†y.";
            container.appendChild(noFlights);
          }
        } catch (error) {
          console.error("L·ªói loadServices:", error);
          const container = document.getElementById("serviceList");
          container.innerHTML = '<p class="text-red-600">L·ªói khi t·∫£i d·ªØ li·ªáu d·ªãch v·ª•.</p>';
        }
      }

      // X·ª≠ l√Ω click n√∫t H·ªßy trong modal ch·ªânh s·ª≠a tour
      document.getElementById("cancelEdit").addEventListener("click", () => {
        document.getElementById("editTourModal").classList.add("hidden");
      }); 
    </script>
  </body>
</html>
