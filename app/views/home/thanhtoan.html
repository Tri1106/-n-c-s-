<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Thanh to√°n tour du l·ªãch</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      padding: 20px;
    }

    .container {
      display: flex;
      max-width: 1200px;
      margin: auto;
      gap: 20px;
    }

    .left-box, .right-box {
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
      padding: 25px;
    }

    .left-box {
      flex: 2;
    }

    .right-box {
      flex: 1;
    }

    h3 {
      color: #004085;
      border-bottom: 1px solid #ccc;
      padding-bottom: 8px;
      margin-bottom: 15px;
    }

    .info-row {
      margin-bottom: 10px;
    }

    .info-row strong {
      display: inline-block;
      width: 120px;
    }

    .highlight {
      color: red;
      font-weight: bold;
    }

    .booking-code {
      color: red;
      font-weight: bold;
    }

    .booking-status {
      color: #007bff;
      font-weight: bold;
    }

    .btn-pay {
      display: block;
      width: 100%;
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 15px;
      font-size: 16px;
      border-radius: 5px;
      margin-top: 20px;
      cursor: pointer;
    }

    .btn-pay:hover {
      background-color: #c82333;
    }

    img.tour-image {
      width: 100%;
      border-radius: 8px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

<div class="container">
  <!-- B√™n tr√°i: th√¥ng tin li√™n l·∫°c + chi ti·∫øt booking -->
  <div class="left-box">
    <h3>TH√îNG TIN LI√äN L·∫†C</h3>
    <div class="info-row"><strong>H·ªç t√™n:</strong> <span id="customerName"></span></div>
    <div class="info-row"><strong>Email:</strong> <span id="customerEmail"></span></div>
    <div class="info-row"><strong>ƒêi·ªán tho·∫°i:</strong> <span id="customerPhone"></span></div>
    <div class="info-row"><strong>ƒê·ªãa ch·ªâ:</strong> <span id="customerAddress"></span></div>
    <div class="info-row"><strong>Ghi ch√∫:</strong> <span id="customerNote"></span></div>

    <h3>CHI TI·∫æT BOOKING</h3>
    <div class="info-row"><strong>M√£ ƒë·∫∑t ch·ªó:</strong> <span class="booking-code" id="bookingCode"></span></div>
    <div class="info-row"><strong>Ng√†y t·∫°o:</strong> <span id="createdAt"></span></div>
    <div class="info-row"><strong>Tr·ªã gi√° booking:</strong> <span id="totalAmount"></span></div>
    <div class="info-row"><strong>ƒê√£ thanh to√°n:</strong> <span id="paidAmount"></span></div>
    <div class="info-row"><strong>C√≤n l·∫°i:</strong> <span id="remainingAmount"></span></div>
    <div class="info-row"><strong>T√¨nh tr·∫°ng:</strong> <span class="booking-status" id="bookingStatus"></span></div>
    <div class="info-row"><strong>H·∫°n thanh to√°n:</strong> <span class="highlight" id="paymentDeadline"></span> <em>(Theo gi·ªù Vi·ªát Nam. S·∫Ω t·ª± ƒë·ªông hu·ª∑ n·∫øu qu√° th·ªùi h·∫°n)</em></div>
  </div>

  <!-- B√™n ph·∫£i: phi·∫øu x√°c nh·∫≠n booking -->
  <div class="right-box">
    <h3>PHI·∫æU X√ÅC NH·∫¨N BOOKING</h3>
    <img src="" class="tour-image" alt="·∫¢nh tour" id="tourImage">
    <p><strong>Tour:</strong> <span id="tourName"></span></p>
    <p><strong>S·ªë booking:</strong> <span class="booking-code" id="bookingCodeRight"></span></p>
    <p><strong>M√£ tour:</strong> <span id="tourID"></span></p>

    <h4>üöå TH√îNG TIN CHUY·∫æN XE</h4>
    <p><strong>Ng√†y ƒëi:</strong> <span id="departureInfo"></span></p>
    <p><strong>Ng√†y v·ªÅ:</strong> <span id="returnInfo"></span></p>

    <form id="paymentForm">
      <input type="hidden" name="bookingCode" id="hiddenBookingCode" value="" />
      <input type="hidden" name="amount" id="hiddenAmount" value="" />
      <button type="submit" class="btn-pay" id="btnPayNow">Thanh to√°n ngay</button>
    </form>
  </div>
</div>

<script>
  function formatCurrency(vnd) {
    return vnd.toLocaleString('vi-VN') + ' ‚Ç´';
  }

  function formatDateTime(dateStr) {
    const date = new Date(dateStr);
    if (isNaN(date)) return '';
    const options = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' };
    return date.toLocaleDateString('vi-VN', options) + ' ' + date.toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});
  }

  async function loadBookingDetails() {
    const urlParams = new URLSearchParams(window.location.search);
    const bookingID = urlParams.get('bookingID');
    if (!bookingID) {
      alert('Kh√¥ng t√¨m th·∫•y m√£ ƒë·∫∑t ch·ªó trong URL.');
      return;
    }

    try {
      const res = await fetch(`/api/bookings/${bookingID}`);
      if (!res.ok) {
        alert('Kh√¥ng t√¨m th·∫•y booking.');
        return;
      }
      const data = await res.json();

      // C·∫≠p nh·∫≠t th√¥ng tin kh√°ch h√†ng
      document.getElementById('customerName').textContent = data.CustomerName || '';
      document.getElementById('customerEmail').textContent = data.Email || '';
      document.getElementById('customerPhone').textContent = data.Phone || '';
      document.getElementById('customerAddress').textContent = data.Address || '';
      document.getElementById('customerNote').textContent = ''; // N·∫øu c√≥ tr∆∞·ªùng ghi ch√∫, c·∫≠p nh·∫≠t t∆∞∆°ng t·ª±

      // C·∫≠p nh·∫≠t th√¥ng tin booking
      document.getElementById('bookingCode').textContent = data.BookingID || 'Ch∆∞a c√≥ m√£';
      document.getElementById('bookingCodeRight').textContent = data.BookingID || 'Ch∆∞a c√≥ m√£';
      document.getElementById('createdAt').textContent = formatDateTime(data.BookingDate) || '';

      // L·∫•y d·ªØ li·ªáu s·ªë l∆∞·ª£ng ƒë·∫∑t t·ª´ sessionStorage
      const bookingDataStr = sessionStorage.getItem('bookingData');
      let adultCount = 1;
      let childCount = 0;
      let singleRoom = false;
      if (bookingDataStr) {
        try {
          const bookingData = JSON.parse(bookingDataStr);
          adultCount = parseInt(bookingData.adult) || 1;
          childCount = parseInt(bookingData.child) || 0;
          singleRoom = bookingData.singleRoom || false;
        } catch (e) {
          console.error('L·ªói khi ph√¢n t√≠ch d·ªØ li·ªáu booking t·ª´ sessionStorage:', e);
        }
      }

      // T√≠nh l·∫°i t·ªïng gi√° tr·ªã booking d·ª±a tr√™n s·ªë l∆∞·ª£ng
      const adultPrice = data.Price || 0;
      const childPrice = Math.round(adultPrice * 0.7);
      const singleRoomFee = 0; // N·∫øu c√≥ ph√≠ ph·ª• thu ph√≤ng ƒë∆°n, c√≥ th·ªÉ l·∫•y t·ª´ API ho·∫∑c c·ªë ƒë·ªãnh

      let totalPrice = adultCount * adultPrice + childCount * childPrice;
      if (singleRoom) totalPrice += singleRoomFee;

      document.getElementById('totalAmount').textContent = formatCurrency(totalPrice);
      document.getElementById('paidAmount').textContent = data.PaidAmount ? formatCurrency(data.PaidAmount) : '0 ‚Ç´';
      const paidAmountValid = typeof data.PaidAmount === 'number' && data.PaidAmount >= 0;
      const priceValid = totalPrice >= 0;
      let remainingAmountValue = 0;
      if (priceValid) {
        if (paidAmountValid) {
          remainingAmountValue = totalPrice - data.PaidAmount;
          if (remainingAmountValue < 0) remainingAmountValue = 0;
        } else {
          remainingAmountValue = totalPrice;
        }
      }
      document.getElementById('remainingAmount').textContent = formatCurrency(remainingAmountValue);
      document.getElementById('bookingStatus').textContent = data.Status || 'Booking c·ªßa qu√Ω kh√°ch ch∆∞a ƒë∆∞·ª£c x√°c nh·∫≠n.';
      document.getElementById('paymentDeadline').textContent = data.PaymentDeadline ? formatDateTime(data.PaymentDeadline) : '';

      // C·∫≠p nh·∫≠t th√¥ng tin tour
      document.getElementById('tourName').textContent = data.TourName || '';
      document.getElementById('tourID').textContent = data.TourID || '';
      document.getElementById('tourImage').src = data.ImageURL || '';
      document.getElementById('tourImage').alt = data.TourName || '·∫¢nh tour';

      // Th√¥ng tin chuy·∫øn xe (n·∫øu c√≥)
      if (data.Flights && data.Flights.length > 0) {
        // S·∫Øp x·∫øp chuy·∫øn ƒëi theo ng√†y kh·ªüi h√†nh
        const sortedFlights = data.Flights.slice().sort((a, b) => new Date(a.DepartureDate) - new Date(b.DepartureDate));
        const departFlight = sortedFlights[0];
        const returnFlight = sortedFlights[sortedFlights.length - 1];

        const optionsDate = { day: '2-digit', month: '2-digit', year: 'numeric' };
        const optionsTime = { hour: '2-digit', minute: '2-digit' };

        if (departFlight && departFlight.DepartureDate) {
          const departDate = new Date(departFlight.DepartureDate);
          const formattedDate = departDate.toLocaleDateString('vi-VN', {day: '2-digit', month: '2-digit', year: 'numeric'});
          // Ch·ªâ l·∫•y ng√†y, kh√¥ng l·∫•y gi·ªù
          // Ch·ªâ l·∫•y ng√†y, kh√¥ng l·∫•y ƒë·ªãa ƒëi·ªÉm
          document.getElementById('departureInfo').textContent = `${formattedDate}`;
        } else {
          document.getElementById('departureInfo').textContent = 'Ch∆∞a c·∫≠p nh·∫≠t';
        }

        if (returnFlight && returnFlight.ReturnDate && returnFlight.ReturnDate !== departFlight.DepartureDate) {
          const returnDate = new Date(returnFlight.ReturnDate);
          const formattedDate = returnDate.toLocaleDateString('vi-VN', {day: '2-digit', month: '2-digit', year: 'numeric'});
          // Ch·ªâ l·∫•y ng√†y, kh√¥ng l·∫•y gi·ªù
          // Ch·ªâ l·∫•y ng√†y, kh√¥ng l·∫•y ƒë·ªãa ƒëi·ªÉm
          document.getElementById('returnInfo').textContent = `${formattedDate}`;
        } else if (departFlight && departFlight.DepartureDate) {
          // N·∫øu ReturnDate kh√¥ng h·ª£p l·ªá ho·∫∑c tr√πng ng√†y ƒëi, kh√¥ng t√≠nh ng√†y v·ªÅ m√† hi·ªÉn th·ªã ch∆∞a c·∫≠p nh·∫≠t
          document.getElementById('returnInfo').textContent = 'Ch∆∞a c·∫≠p nh·∫≠t';
        } else {
          document.getElementById('returnInfo').textContent = 'Ch∆∞a c·∫≠p nh·∫≠t';
        }
      } else {
        document.getElementById('departureInfo').textContent = 'Ch∆∞a c·∫≠p nh·∫≠t';
        document.getElementById('returnInfo').textContent = 'Ch∆∞a c·∫≠p nh·∫≠t';
      }

      // C·∫≠p nh·∫≠t form ·∫©n ƒë·ªÉ g·ª≠i thanh to√°n
      document.getElementById('hiddenBookingCode').value = data.BookingID || '';
      document.getElementById('hiddenAmount').value = totalPrice || '';

    } catch (error) {
      console.error('L·ªói khi t·∫£i th√¥ng tin booking:', error);
      alert('L·ªói khi t·∫£i th√¥ng tin booking.');
    }
  }

  window.onload = () => {
    loadBookingDetails();
  };

  // X·ª≠ l√Ω khi b·∫•m n√∫t Thanh to√°n ngay: m·ªü tab m·ªõi sang trang payment-page v·ªõi d·ªØ li·ªáu c·∫ßn thi·∫øt
  document.getElementById('btnPayNow').addEventListener('click', function(event) {
    event.preventDefault();

    const bookingCode = document.getElementById('hiddenBookingCode').value;
    const amount = document.getElementById('hiddenAmount').value;
    const customerName = document.getElementById('customerName').textContent;
    const customerEmail = document.getElementById('customerEmail').textContent;
    const customerPhone = document.getElementById('customerPhone').textContent;
    const tourID = document.getElementById('tourID').textContent;

    if (!bookingCode || !amount) {
      alert('Thi·∫øu th√¥ng tin ƒë·∫∑t tour ƒë·ªÉ thanh to√°n.');
      return;
    }

    // T·∫°o URL v·ªõi query params truy·ªÅn d·ªØ li·ªáu sang trang payment-page
    const params = new URLSearchParams({
      bookingCode,
      amount,
      name: customerName,
      email: customerEmail,
      phone: customerPhone,
      tourID
    });

    const paymentUrl = `/payment-page?${params.toString()}`;
    window.open(paymentUrl, '_blank');
  });
</script>
</body>
</html>
