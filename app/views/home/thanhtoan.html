<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Thanh to√°n tour du l·ªãch</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      padding: 20px;
    }

    .container {
      display: flex;
      max-width: 1200px;
      margin: auto;
      gap: 20px;
    }

    .left-box, .right-box {
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
      padding: 25px;
    }

    .left-box {
      flex: 2;
    }

    .right-box {
      flex: 1;
    }

    h3 {
      color: #004085;
      border-bottom: 1px solid #ccc;
      padding-bottom: 8px;
      margin-bottom: 15px;
    }

    .info-row {
      margin-bottom: 10px;
    }

    .info-row strong {
      display: inline-block;
      width: 120px;
    }

    .highlight {
      color: red;
      font-weight: bold;
    }

    .booking-code {
      color: red;
      font-weight: bold;
    }

    .booking-status {
      color: #007bff;
      font-weight: bold;
    }

    .btn-pay {
      display: block;
      width: 100%;
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 15px;
      font-size: 16px;
      border-radius: 5px;
      margin-top: 20px;
      cursor: pointer;
    }

    .btn-pay:hover {
      background-color: #c82333;
    }

    img.tour-image {
      width: 100%;
      border-radius: 8px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

<div class="container">
  <!-- B√™n tr√°i: th√¥ng tin li√™n l·∫°c + chi ti·∫øt booking -->
  <div class="left-box">
    <h3>TH√îNG TIN LI√äN L·∫†C</h3>
    <div class="info-row"><strong>H·ªç t√™n:</strong> <span id="customerName"></span></div>
    <div class="info-row"><strong>Email:</strong> <span id="customerEmail"></span></div>
    <div class="info-row"><strong>ƒêi·ªán tho·∫°i:</strong> <span id="customerPhone"></span></div>
    <div class="info-row"><strong>ƒê·ªãa ch·ªâ:</strong> <span id="customerAddress"></span></div>
    <div class="info-row"><strong>Ghi ch√∫:</strong> <span id="customerNote"></span></div>

    <h3>CHI TI·∫æT BOOKING</h3>
    <div class="info-row"><strong>M√£ ƒë·∫∑t ch·ªó:</strong> <span class="booking-code" id="bookingCode"></span></div>
    <div class="info-row"><strong>Ng√†y t·∫°o:</strong> <span id="createdAt"></span></div>
    <div class="info-row"><strong>Tr·ªã gi√° booking:</strong> <span id="totalAmount"></span></div>
    <div class="info-row"><strong>ƒê√£ thanh to√°n:</strong> <span id="paidAmount"></span></div>
    <div class="info-row"><strong>C√≤n l·∫°i:</strong> <span id="remainingAmount"></span></div>
    <div class="info-row"><strong>T√¨nh tr·∫°ng:</strong> <span class="booking-status" id="bookingStatus"></span></div>
    <div class="info-row"><strong>H·∫°n thanh to√°n:</strong> <span class="highlight" id="paymentDeadline"></span> <em>(Theo gi·ªù Vi·ªát Nam. S·∫Ω t·ª± ƒë·ªông hu·ª∑ n·∫øu qu√° th·ªùi h·∫°n)</em></div>
  </div>

  <!-- B√™n ph·∫£i: phi·∫øu x√°c nh·∫≠n booking -->
  <div class="right-box">
    <h3>PHI·∫æU X√ÅC NH·∫¨N BOOKING</h3>
    <img src="" class="tour-image" alt="·∫¢nh tour" id="tourImage">
    <p><strong>Tour:</strong> <span id="tourName"></span></p>
    <p><strong>S·ªë booking:</strong> <span class="booking-code" id="bookingCodeRight"></span></p>
    <p><strong>M√£ tour:</strong> <span id="tourID"></span></p>

    <h4>üöå TH√îNG TIN CHUY·∫æN XE</h4>
    <p><strong>Ng√†y ƒëi:</strong> <span id="departureInfo"></span></p>
    <p><strong>Ng√†y v·ªÅ:</strong> <span id="returnInfo"></span></p>

    <form action="/thanh-toan" method="POST" id="paymentForm">
      <input type="hidden" name="bookingCode" id="hiddenBookingCode" value="" />
      <input type="hidden" name="amount" id="hiddenAmount" value="" />
      <button type="submit" class="btn-pay">Thanh to√°n ngay</button>
    </form>
  </div>
</div>

<script>
  function formatCurrency(vnd) {
    return vnd.toLocaleString('vi-VN') + ' ‚Ç´';
  }

  function formatDateTime(dateStr) {
    const date = new Date(dateStr);
    if (isNaN(date)) return '';
    const options = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' };
    return date.toLocaleDateString('vi-VN', options) + ' ' + date.toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});
  }

  async function loadBookingDetails() {
    // L·∫•y bookingCode t·ª´ query param
    const urlParams = new URLSearchParams(window.location.search);
    const bookingCode = urlParams.get('bookingCode');
    if (!bookingCode) {
      alert('Kh√¥ng t√¨m th·∫•y m√£ ƒë·∫∑t ch·ªó.');
      return;
    }

    try {
      const res = await fetch(`/api/booking-details/${bookingCode}`);
      if (!res.ok) {
        alert('Kh√¥ng t√¨m th·∫•y booking.');
        return;
      }
      const data = await res.json();

      console.log("Flights data:", data.flights); // Log d·ªØ li·ªáu flights ƒë·ªÉ ki·ªÉm tra

      // C·∫≠p nh·∫≠t th√¥ng tin kh√°ch h√†ng
      document.getElementById('customerName').textContent = data.booking.CustomerName || '';
      document.getElementById('customerEmail').textContent = data.booking.Email || '';
      document.getElementById('customerPhone').textContent = data.booking.Phone || '';
      document.getElementById('customerAddress').textContent = data.booking.Address || '';
      document.getElementById('customerNote').textContent = data.booking.Note || '';

      // C·∫≠p nh·∫≠t th√¥ng tin booking
      document.getElementById('bookingCode').textContent = data.booking.BookingCode || '';
      document.getElementById('bookingCodeRight').textContent = data.booking.BookingCode || '';
      document.getElementById('createdAt').textContent = formatDateTime(data.booking.CreatedAt) || '';
      document.getElementById('totalAmount').textContent = formatCurrency(data.booking.TotalAmount) || '';
      document.getElementById('paidAmount').textContent = formatCurrency(data.booking.PaidAmount) || '';
      document.getElementById('remainingAmount').textContent = formatCurrency(data.booking.RemainingAmount) || '';
      document.getElementById('bookingStatus').textContent = data.booking.Status || '';
      document.getElementById('paymentDeadline').textContent = formatDateTime(data.booking.PaymentDeadline) || '';

      // C·∫≠p nh·∫≠t th√¥ng tin tour
      document.getElementById('tourName').textContent = data.tour.TourName || '';
      document.getElementById('tourID').textContent = data.tour.TourID || '';
      document.getElementById('tourImage').src = data.tour.ImageURL || '';
      document.getElementById('tourImage').alt = data.tour.TourName || '·∫¢nh tour';

      // C·∫≠p nh·∫≠t th√¥ng tin chuy·∫øn xe (l·∫•y t·ª´ flights)
      if (data.flights && data.flights.length > 0) {
        // S·∫Øp x·∫øp flights theo DepartureDate tƒÉng d·∫ßn
        const sortedFlights = data.flights.slice().sort((a, b) => new Date(a.DepartureDate) - new Date(b.DepartureDate));
        const departFlight = sortedFlights[0];
        const returnFlight = sortedFlights[sortedFlights.length - 1];

        const optionsDate = { day: '2-digit', month: '2-digit', year: 'numeric' };
        const optionsTime = { hour: '2-digit', minute: '2-digit' };

        if (departFlight) {
          const departDate = new Date(departFlight.DepartureDate);
          document.getElementById('departureInfo').textContent = `${departDate.toLocaleDateString('vi-VN', optionsDate)} ‚Äì ${departDate.toLocaleTimeString('vi-VN', optionsTime)} ‚Üí ${departFlight.DeparturePoint} ‚Äì ${departFlight.DestinationPoint}`;
        } else {
          document.getElementById('departureInfo').textContent = 'Ch∆∞a c·∫≠p nh·∫≠t';
        }
        if (returnFlight && returnFlight.ReturnDate && returnFlight.ReturnDate !== departFlight.DepartureDate) {
          const returnDate = new Date(returnFlight.ReturnDate);
          document.getElementById('returnInfo').textContent = `${returnDate.toLocaleDateString('vi-VN', optionsDate)} ‚Äì ${returnDate.toLocaleTimeString('vi-VN', optionsTime)} ‚Üí ${returnFlight.DestinationPoint} ‚Äì ${returnFlight.DeparturePoint}`;
        } else {
          // N·∫øu ReturnDate kh√¥ng h·ª£p l·ªá ho·∫∑c tr√πng ng√†y ƒëi, t√≠nh ng√†y v·ªÅ = ng√†y ƒëi + ThoiGianLyTuong (s·ªë ng√†y tour)
          const departDate = new Date(departFlight.DepartureDate);
          const tourDays = data.tour.ThoiGianLyTuong ? parseInt(data.tour.ThoiGianLyTuong) : 1;
          const calculatedReturnDate = new Date(departDate);
          calculatedReturnDate.setDate(departDate.getDate() + tourDays);
          document.getElementById('returnInfo').textContent = `${calculatedReturnDate.toLocaleDateString('vi-VN', optionsDate)} ‚Äì ${calculatedReturnDate.toLocaleTimeString('vi-VN', optionsTime)} ‚Üí ${departFlight.DestinationPoint} ‚Äì ${departFlight.DeparturePoint} (t√≠nh theo s·ªë ng√†y tour)`;
        }
      } else {
        document.getElementById('departureInfo').textContent = 'Ch∆∞a c·∫≠p nh·∫≠t';
        document.getElementById('returnInfo').textContent = 'Ch∆∞a c·∫≠p nh·∫≠t';
      }

      // C·∫≠p nh·∫≠t form ·∫©n
      document.getElementById('hiddenBookingCode').value = data.booking.BookingCode || '';
      document.getElementById('hiddenAmount').value = data.booking.RemainingAmount || '';

    } catch (error) {
      console.error('L·ªói khi t·∫£i th√¥ng tin booking:', error);
      alert('L·ªói khi t·∫£i th√¥ng tin booking.');
    }
  }

  window.onload = () => {
    loadBookingDetails();
  };
</script>

</body>
</html>
