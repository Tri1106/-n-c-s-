const express = require('express');
const path = require('path');
const bcrypt = require('bcryptjs');
const db = require('./db'); // ÄÃ£ káº¿t ná»‘i SQL Server
const app = express();

// Middlewares
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Hiá»ƒn thá»‹ giao diá»‡n quáº£n lÃ½ tÃ i khoáº£n
app.get('/', async (req, res) => {
    try {
        const result = await db.query(`SELECT * FROM Users`); // Báº£ng Users nhÃ©
        const users = result.recordset;

        let rows = users.map(user => `
            <tr>
                <td>${user.Username}</td>
                <td>${user.Email}</td>
                <td>${user.Phone}</td>
                <td>${user.FullName}</td>
                <td>${user.Role}</td>
                <td class="action-buttons">
                    <button class="edit-btn" onclick="location.href='/edit/${user.Id}'">Sá»­a</button>
                    <button class="delete-btn" onclick="if(confirm('Báº¡n cÃ³ cháº¯c muá»‘n xoÃ¡?')) location.href='/delete/${user.Id}'">XoÃ¡</button>
                </td>
            </tr>
        `).join('');

        res.send(`
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quáº£n lÃ½ tÃ i khoáº£n</title>
    <style>
        /* (CSS giá»¯ nguyÃªn nhÆ° báº¡n Ä‘Ã£ cÃ³) */
        body { font-family: Arial, sans-serif; background: #f4f6f8; margin: 0; }
        header { background: #2e4357; color: white; padding: 20px; text-align: center; }
        nav { background: #34495e; padding: 10px 0; }
        nav ul { list-style: none; display: flex; justify-content: center; gap: 30px; margin: 0; padding: 0; }
        nav ul li, nav ul li a { color: white; font-weight: bold; text-decoration: none; }
        main { padding: 30px; max-width: 1200px; margin: auto; }
        h2 { text-align: center; color: #2c3e50; }
        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden; }
        th, td { padding: 12px 15px; border-bottom: 1px solid #ddd; text-align: center; }
        th { background-color: #2980b9; color: white; }
        tr:hover { background-color: #f9f9f9; }
        .action-buttons button { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; }
        .edit-btn { background-color: #27ae60; }
        .delete-btn { background-color: #c0392b; }
    </style>
</head>
<body>
    <header>
        <h1>Quáº£n trá»‹ viÃªn - Quáº£n lÃ½ tÃ i khoáº£n</h1>
        <nav>
            <ul>
                <li>ğŸ‘¥ Quáº£n lÃ½ tÃ i khoáº£n</li>
                <li>ğŸ“„ Quáº£n lÃ½ tour</li>
                <li>ğŸ’µ Doanh thu</li>
                <li>ğŸ“Š Thá»‘ng kÃª</li>
                <li>ğŸ§¾ Quáº£n lÃ½ Ä‘Æ¡n Ä‘áº·t</li>
                <li><a href="#">ÄÄƒng xuáº¥t</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <h2>Danh sÃ¡ch tÃ i khoáº£n ngÆ°á»i dÃ¹ng</h2>
        <table>
            <thead>
                <tr>
                    <th>TÃªn Ä‘Äƒng nháº­p</th>
                    <th>Email</th>
                    <th>SÄT</th>
                    <th>Há» tÃªn</th>
                    <th>Vai trÃ²</th>
                    <th>HÃ nh Ä‘á»™ng</th>
                </tr>
            </thead>
            <tbody>
                ${rows}
            </tbody>
        </table>
    </main>
</body>
</html>
        `);
    } catch (err) {
        console.error(err);
        res.status(500).send('Lá»—i server');
    }
});

// Xá»­ lÃ½ xoÃ¡ ngÆ°á»i dÃ¹ng
app.get('/delete/:id', async (req, res) => {
    try {
        const { id } = req.params;
        await db.query(`DELETE FROM Users WHERE Id = @id`, {
            input: { name: 'id', type: db.sql.Int, value: id }
        });
        res.redirect('/');
    } catch (err) {
        console.error(err);
        res.status(500).send('Lá»—i khi xoÃ¡ user');
    }
});

// Hiá»ƒn thá»‹ form chá»‰nh sá»­a
app.get('/edit/:id', async (req, res) => {
    try {
        const { id } = req.params;
        const result = await db.query(`SELECT * FROM Users WHERE Id = @id`, {
            input: { name: 'id', type: db.sql.Int, value: id }
        });
        const user = result.recordset[0];
        if (!user) return res.status(404).send('KhÃ´ng tÃ¬m tháº¥y user');

        res.send(`
            <h2>Chá»‰nh sá»­a tÃ i khoáº£n</h2>
            <form action="/edit/${user.Id}" method="post">
                <label>Username:</label><br/>
                <input type="text" name="Username" value="${user.Username}" required><br/>
                <label>Email:</label><br/>
                <input type="email" name="Email" value="${user.Email}" required><br/>
                <label>SÄT:</label><br/>
                <input type="text" name="Phone" value="${user.Phone}" required><br/>
                <label>Há» tÃªn:</label><br/>
                <input type="text" name="FullName" value="${user.FullName}" required><br/>
                <label>Vai trÃ²:</label><br/>
                <input type="text" name="Role" value="${user.Role}" required><br/><br/>
                <button type="submit">LÆ°u</button>
            </form>
        `);
    } catch (err) {
        console.error(err);
        res.status(500).send('Lá»—i server');
    }
});

// Xá»­ lÃ½ lÆ°u chá»‰nh sá»­a
app.post('/edit/:id', async (req, res) => {
    try {
        const { id } = req.params;
        const { Username, Email, Phone, FullName, Role } = req.body;

        await db.query(`UPDATE Users 
                        SET Username=@Username, Email=@Email, Phone=@Phone, FullName=@FullName, Role=@Role 
                        WHERE Id=@id`, {
            input: [
                { name: 'Username', type: db.sql.NVarChar, value: Username },
                { name: 'Email', type: db.sql.NVarChar, value: Email },
                { name: 'Phone', type: db.sql.NVarChar, value: Phone },
                { name: 'FullName', type: db.sql.NVarChar, value: FullName },
                { name: 'Role', type: db.sql.NVarChar, value: Role },
                { name: 'id', type: db.sql.Int, value: id }
            ]
        });

        res.redirect('/');
    } catch (err) {
        console.error(err);
        res.status(500).send('Lá»—i khi lÆ°u chá»‰nh sá»­a');
    }
});

// Server start
const port = 3000;
app.listen(port, () => {
    console.log(`Server Ä‘ang cháº¡y táº¡i http://localhost:${port}`);
});
